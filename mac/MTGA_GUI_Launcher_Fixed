#!/bin/bash

# MTGA GUI 启动器 - macOS双击启动专用版本
# 解决双击启动时的环境和权限问题

# 设置错误处理
set -e

# 获取应用包路径和可执行文件路径
APP_BUNDLE="$(dirname "$(dirname "$(dirname "$0")")")"
SCRIPT_DIR="$(dirname "$0")"
EXECUTABLE_PATH="$SCRIPT_DIR/MTGA_GUI-v1.2.0-arm64"

# 日志文件用于调试
LOG_FILE="/tmp/mtga_launcher.log"

# 记录启动信息
echo "$(date): 启动器开始执行" > "$LOG_FILE"
echo "APP_BUNDLE: $APP_BUNDLE" >> "$LOG_FILE"
echo "SCRIPT_DIR: $SCRIPT_DIR" >> "$LOG_FILE" 
echo "EXECUTABLE_PATH: $EXECUTABLE_PATH" >> "$LOG_FILE"

# 检查可执行文件
if [[ ! -f "$EXECUTABLE_PATH" ]]; then
    echo "主程序文件不存在，尝试查找..." >> "$LOG_FILE"
    EXECUTABLE_PATH=$(find "$SCRIPT_DIR" -name "*MTGA*" -type f -executable | grep -v Launcher | head -1)
    echo "找到可执行文件: $EXECUTABLE_PATH" >> "$LOG_FILE"
    
    if [[ ! -f "$EXECUTABLE_PATH" ]]; then
        echo "错误: 无法找到可执行文件" >> "$LOG_FILE"
        osascript -e 'display dialog "无法找到应用程序可执行文件\n请查看 /tmp/mtga_launcher.log" buttons {"OK"} default button "OK"'
        exit 1
    fi
fi

# 切换到正确的工作目录
cd "$SCRIPT_DIR"
echo "工作目录: $(pwd)" >> "$LOG_FILE"

# 使用osascript请求管理员权限并启动
echo "请求管理员权限并启动程序..." >> "$LOG_FILE"

# 设置UTF-8编码环境变量，解决中文字符编码问题
export LANG="zh_CN.UTF-8"
export LC_ALL="zh_CN.UTF-8"
export PYTHONIOENCODING="utf-8"

# 使用简单的启动方式
osascript << EOF
try
    do shell script "export LANG=zh_CN.UTF-8; export LC_ALL=zh_CN.UTF-8; export PYTHONIOENCODING=utf-8; '$EXECUTABLE_PATH'" with administrator privileges
on error errMsg number errNum
    display dialog "启动失败: " & errMsg buttons {"OK"} default button "OK"
end try
EOF

echo "$(date): 启动器执行完成" >> "$LOG_FILE"