#!/bin/bash

# MTGA GUI 启动器 - 无需管理员权限版本
# 保留完整的 GUI 功能（剪贴板、窗口控制）

# 获取路径
SCRIPT_DIR="$(dirname "$0")"
EXECUTABLE_PATH="$SCRIPT_DIR/MTGA_GUI-v1.2.0-arm64"

# 日志文件
LOG_FILE="/tmp/mtga_launcher.log"

# 记录启动信息
{
    echo "$(date): 启动器开始执行"
    echo "SCRIPT_DIR: $SCRIPT_DIR"
    echo "EXECUTABLE_PATH: $EXECUTABLE_PATH"
} > "$LOG_FILE"

# 检查可执行文件
if [[ ! -f "$EXECUTABLE_PATH" ]]; then
    echo "主程序文件不存在，尝试查找..." >> "$LOG_FILE"
    EXECUTABLE_PATH=$(find "$SCRIPT_DIR" -name "*MTGA*" -type f -executable | grep -v Launcher | head -1)
    echo "找到可执行文件: $EXECUTABLE_PATH" >> "$LOG_FILE"
    
    if [[ ! -f "$EXECUTABLE_PATH" ]]; then
        echo "错误: 无法找到可执行文件" >> "$LOG_FILE"
        osascript -e 'display dialog "无法找到应用程序可执行文件\n请查看 /tmp/mtga_launcher.log" buttons {"OK"} default button "OK"'
        exit 1
    fi
fi

# 设置环境变量（关键！修复 Tkinter 功能）
export LANG="zh_CN.UTF-8"
export LC_ALL="zh_CN.UTF-8"
export PYTHONIOENCODING="utf-8"
export TCL_LIBRARY="$SCRIPT_DIR/tcl-files"
export TK_LIBRARY="$SCRIPT_DIR/tk-files"

# 记录环境变量
{
    echo "环境变量设置:"
    echo "  TCL_LIBRARY=$TCL_LIBRARY"
    echo "  TK_LIBRARY=$TK_LIBRARY"
} >> "$LOG_FILE"

# 切换到正确的工作目录
cd "$SCRIPT_DIR"
echo "工作目录: $(pwd)" >> "$LOG_FILE"

# 直接以普通用户身份启动（保留所有 GUI 功能）
echo "以普通用户身份启动..." >> "$LOG_FILE"
"$EXECUTABLE_PATH" >> "$LOG_FILE" 2>&1 &

echo "$(date): 启动器执行完成" >> "$LOG_FILE"