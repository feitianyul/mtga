#!/bin/bash

# 使用 macOS 官方 AppleScript 提权 API 运行脚本
# 通过 osascript 调用 AppleScript 的 "do shell script with administrator privileges"
# 这会弹出系统认证对话框，让用户输入管理员密码

# 获取脚本所在目录的绝对路径
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TARGET_SCRIPT="$SCRIPT_DIR/../Resources/mtga_project/run_mtga_gui.sh"

# 检查目标脚本是否存在
if [ ! -f "$TARGET_SCRIPT" ]; then
    echo "错误: 找不到目标脚本 $TARGET_SCRIPT"
    exit 1
fi

# 1. 使用 osascript -e 调用 AppleScript
# 2. do shell script "命令" with administrator privileges 表示需要管理员权限
# 3. with prompt "提示信息" 用于显示认证对话框的提示文本
# 4. 命令需要用引号包裹,特殊字符需要转义
# 5. 使用固定文件存储命令输出的方法:
#    - 使用项目内固定位置的日志文件
#    - > 重定向标准输出
#    - 2>&1 重定向标准错误到标准输出
#    - 使用后台运行避免在dock显示
OUTPUT_FILE="$SCRIPT_DIR/../Resources/mtga_project/startup.log"
# 在后台运行目标脚本，避免启动脚本在dock中显示
osascript -e "do shell script \"'$TARGET_SCRIPT' > '$OUTPUT_FILE' 2>&1 &\" with administrator privileges with prompt \"MTGA GUI 需要管理员权限来执行操作\""
# 等待一下让日志文件生成
sleep 2
cat "$OUTPUT_FILE"

# 检查执行结果
if [ $? -eq 0 ]; then
    echo "脚本执行成功"
else
    echo "脚本执行失败或用户取消了认证"
    exit 1
fi
