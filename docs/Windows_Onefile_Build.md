# Windows 单文件构建指南

本文档说明如何使用 Nuitka 构建 MTGA 的单文件可执行版本，这是推荐的发行方式。

## 概述

单文件构建将整个应用程序打包为一个独立的 `.exe` 文件，便于分发和部署。与独立版本相比，单文件版本有以下特点：

- ✅ 仅一个 `.exe` 文件，便于分发
- ✅ 启动时自动解压到临时目录  
- ✅ 包含所有依赖，无需额外文件
- ✅ 自动请求管理员权限
- ✅ 支持用户数据持久化存储
- ⚠️ 首次运行较慢（需要解压）

## 环境要求

### 必需软件
- **Visual Studio 2022** - 需要 C++ 构建工具
- **Python 3.13** - 通过 `uv` 管理
- **uv** - Python 包管理器

### 系统要求
- Windows 10 或更高版本
- 管理员权限（用于修改 hosts 文件和监听 443 端口）
- 至少 2GB 可用磁盘空间（构建过程需要）

## 构建步骤

### 1. 环境准备

```bash
# 安装依赖
uv sync --extra win-build
```

### 2. 执行构建

```bash
# 运行构建脚本
build_onefile.bat
```

构建脚本会自动执行以下操作：
- 检查虚拟环境和依赖
- 检查 Visual Studio 2022 安装
- 使用 Nuitka 编译单文件版本
- 包含所有必要的资源文件

### 3. 输出文件

构建成功后，输出文件位于：
```
dist-onefile/MTGA_GUI-v{版本号}-x64.exe
```

## 版本管理

### 修改版本号

编辑 `build_onefile.bat` 文件顶部的版本配置：

```batch
REM ========== 版本配置 ==========
set "VERSION=1.1.0"
REM ================================
```

版本号会自动应用到输出文件名：`MTGA_GUI-v1.1.0-x64.exe`

### 发行版命名规范

- 格式：`MTGA_GUI-v{版本号}-x64.exe`
- 示例：`MTGA_GUI-v1.1.0-x64.exe`
- 平台：x64（64位 Windows）

## 用户数据持久化

单文件版本使用持久化用户数据目录存储重要文件：

### 数据存储位置
- **Windows**：`%APPDATA%\MTGA\`
- **包含内容**：
  - `mtga_config.yaml` - 配置文件
  - `ca/` - SSL 证书文件夹
  - `hosts.backup` - hosts 文件备份
  - `backups/` - 数据备份文件夹

### 用户数据管理功能
单文件版本提供专门的"用户数据管理"标签页，包括：
- **打开目录** - 访问用户数据目录
- **备份数据** - 创建带时间戳的完整备份
- **还原数据** - 从最新备份恢复数据
- **清除数据** - 安全删除用户数据（保留备份）

## 构建优化

### 资源文件包含
构建脚本自动包含以下资源：
- SSL 证书配置文件（`ca/` 目录）
- OpenSSL 可执行文件和库
- 应用程序图标
- 模块化组件（`modules/` 目录）

### Nuitka 配置参数
- `--onefile` - 单文件模式
- `--msvc=latest` - 使用最新 MSVC 编译器
- `--windows-uac-admin` - 自动请求管理员权限
- `--windows-console-mode=disable` - 禁用控制台窗口
- `--enable-plugin=tk-inter` - 启用 tkinter 支持

## 故障排除

### 常见问题

1. **构建失败 - Visual Studio 未找到**
   ```
   错误：未找到 Visual Studio 2022
   ```
   **解决方案**：安装 Visual Studio 2022 Community 版本，确保包含 C++ 构建工具

2. **构建失败 - 虚拟环境问题**
   ```
   错误：虚拟环境不存在
   ```
   **解决方案**：运行 `uv sync --extra win-build` 安装依赖

3. **构建时间过长**
   - 单文件构建通常需要 30-40 分钟
   - 首次构建会更慢（需要下载依赖）
   - 建议在构建过程中不要进行其他高 CPU 占用任务

4. **运行时解压慢**
   - 首次运行需要解压到临时目录
   - 后续运行会更快（除非临时目录被清理）
   - 可以考虑使用独立版本（`build_standalone.bat`）用于开发测试

### 调试模式

如需调试构建过程，可以编辑构建脚本添加以下参数：
```batch
--debug ^
--verbose ^
```

## 与其他构建方式对比

| 特性 | 单文件版本 | 独立版本 | 脚本版本 |
|------|------------|----------|----------|
| 文件数量 | 1个exe | 多个文件 | 源码+依赖 |
| 分发便利性 | ✅ 最佳 | ⚠️ 需要整个目录 | ❌ 需要Python环境 |
| 启动速度 | ⚠️ 首次较慢 | ✅ 快速 | ✅ 快速 |
| 调试便利性 | ❌ 困难 | ⚠️ 一般 | ✅ 最佳 |
| 推荐用途 | 🎯 生产发行 | 开发测试 | 开发调试 |

## 最佳实践

1. **版本发布流程**
   - 更新版本号在 `build_onefile.bat`
   - 执行完整构建和测试
   - 发布到 GitHub Releases

2. **测试建议**
   - 在干净的 Windows 系统上测试
   - 验证管理员权限提升
   - 测试用户数据持久化功能
   - 确认代理服务器正常工作

3. **分发注意事项**
   - 文件较大（通常 50-100MB）
   - 杀毒软件可能误报（属正常现象）
   - 建议提供 SHA256 校验和