name: ðŸš€ æž„å»ºå’Œå‘å¸ƒç‰ˆæœ¬(TAURI) - test win
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release tag (ä¾‹å¦‚ï¼šv2.0.0-beta.7-proxy.1)"
        required: true
        default: "v2.0.0-beta.7-proxy.1"
      prerelease:
        description: "æ˜¯å¦æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ (true/false)"
        required: true
        default: "true"
      draft:
        description: "æ˜¯å¦åˆ›å»ºä¸ºè‰ç¨¿ (true/false)"
        required: true
        default: "false"

permissions:
  contents: write

env:
  PYTHON_VERSION: "3.13"
  VERSION: "${{ github.event.inputs.version }}"

jobs:
  build-windows:
    name: ðŸªŸ æž„å»º Windows
    runs-on: windows-latest
    env:
      UV_CACHE_DIR: "${{ github.workspace }}\\.uv_cache"
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: ðŸ è®¾ç½® Python
        id: setup-python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸŸ¢ è®¾ç½® Node
        uses: actions/setup-node@v6
        with:
          node-version-file: package.json

      - name: ðŸ”§ å¯ç”¨ Corepack
        id: pnpm-store
        env:
          COREPACK_ENABLE_DOWNLOAD_PROMPT: "0"
        run: |
          corepack enable
          pnpm --version
          $store = pnpm store path --silent
          "pnpm_store_path=$store" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: ðŸ’¾ ç¼“å­˜ pnpm store
        uses: actions/cache@v5
        with:
          path: ${{ steps.pnpm-store.outputs.pnpm_store_path }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: ðŸ¦€ è®¾ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ðŸ§° ç¼“å­˜ Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            src-tauri
          shared-key: tauri-${{ runner.os }}-x64

      - name: ðŸ” è°ƒè¯• uv.lock
        run: |
          Get-Location
          if (Test-Path python-src/uv.lock) {
            Get-Item python-src/uv.lock | Format-List FullName,Length
            Get-Content python-src/uv.lock -TotalCount 5
          } else {
            Write-Host "python-src/uv.lock ä¸å­˜åœ¨"
          }

      - name: ðŸ§® è®¡ç®— uv.lock å“ˆå¸Œ
        id: uv-lock-hash
        run: |
          if (Test-Path python-src/uv.lock) {
            $hash = (Get-FileHash python-src/uv.lock -Algorithm SHA256).Hash
          } else {
            $hash = "missing"
            Write-Host "âš ï¸ uv.lock ä¸å­˜åœ¨ï¼Œç¼“å­˜ key ä½¿ç”¨ missing"
          }
          "hash=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: ðŸ’¾ ç¼“å­˜ uv ä¾èµ–
        uses: actions/cache@v5
        with:
          path: |
            python-src/.venv
            .uv_cache
            ${{ env.USERPROFILE }}\.local\bin\uv.exe
            ${{ env.USERPROFILE }}\.local\bin\uvx.exe
          key: ${{ runner.os }}-py-${{ steps.setup-python.outputs.python-version }}-uv-win-${{ steps.uv-lock-hash.outputs.hash }}
          restore-keys: |
            ${{ runner.os }}-py-${{ steps.setup-python.outputs.python-version }}-uv-win-

      - name: ðŸ“¦ å®‰è£… uv
        run: |
          $ErrorActionPreference = "Stop"
          $uvBinDir = Join-Path $env:USERPROFILE ".local\\bin"
          $env:PATH = "$uvBinDir;$env:PATH"
          $uvBinDir | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          for ($i = 1; $i -le 3; $i++) {
            if (Get-Command uv -ErrorAction SilentlyContinue) {
              break
            }
            Write-Host "ðŸ” å°è¯•å®‰è£… uvï¼ˆç¬¬ $i æ¬¡ï¼‰..."
            try {
              Invoke-WebRequest -Uri "https://astral.sh/uv/install.ps1" -OutFile "install.ps1"
              ./install.ps1
            } catch {
              Write-Host "âš ï¸ uv å®‰è£…è„šæœ¬æ‰§è¡Œå¤±è´¥: $($_.Exception.Message)"
            }
            Start-Sleep -Seconds (5 * $i)
          }

          if (-not (Get-Command uv -ErrorAction SilentlyContinue)) {
            throw "uv å®‰è£…å¤±è´¥ï¼ˆå¤šæ¬¡é‡è¯•åŽä»ä¸å¯ç”¨ï¼‰"
          }

          uv --version

      - name: ðŸ”§ åŒæ­¥ Python ä¾èµ–
        run: uv sync --project .
        working-directory: python-src

      - name: ðŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: ðŸ“¥ å‡†å¤‡ pyembed Python
        run: |
          $ErrorActionPreference = "Stop"
          $pyembedDir = "src-tauri/pyembed"
          New-Item -ItemType Directory -Path $pyembedDir -Force | Out-Null
          $assetUrl = gh api /repos/astral-sh/python-build-standalone/releases/latest `
            -H "Accept: application/vnd.github+json" `
            -H "X-GitHub-Api-Version: 2022-11-28" `
            --jq '.assets[] | select(.name | test("cpython-3\\.13\\..*\\+.*-x86_64-pc-windows-msvc-install_only_stripped\\.tar\\.gz")) | .browser_download_url' |
            Select-Object -First 1
          if (-not $assetUrl) { throw "âŒ æœªæ‰¾åˆ°åŒ¹é…çš„ Python æž„å»ºäº§ç‰©" }
          $archivePath = Join-Path $pyembedDir "python-standalone.tar.gz"
          Write-Host "â¬‡ï¸ ä¸‹è½½: $assetUrl"
          Invoke-WebRequest -Uri $assetUrl -OutFile $archivePath
          tar -xzf $archivePath -C $pyembedDir

      - name: ðŸ§¾ å†™å…¥ pyembed .env
        run: |
          $envDir = "src-tauri/pyembed/python/Lib"
          New-Item -ItemType Directory -Path $envDir -Force | Out-Null
          Copy-Item -Path ".env.example" -Destination (Join-Path $envDir ".env") -Force

      - name: ðŸ§© å®‰è£… pytauri ä¾èµ–
        run: pnpm pytauri:install:win
        working-directory: .

      - name: ðŸ§± æ‰“åŒ… Tauri
        run: pnpm tauri:bundle:win:ci
        working-directory: .

      - name: ðŸ·ï¸ è¾“å‡ºé‡å‘½åå‰å®‰è£…åŒ…åˆ—è¡¨
        run: |
          Write-Host "ðŸ—‚ï¸ é‡å‘½åå‰æ–‡ä»¶åˆ—è¡¨:"
          Get-ChildItem "src-tauri/target/bundle-release/bundle/nsis" -Filter *.exe |
            Select-Object -ExpandProperty Name |
            ForEach-Object { Write-Host " - $_" }
          $version = "${{ env.VERSION }}"
          $tag = "windows"
          $escaped = [regex]::Escape("_${version}_")
          Write-Host "ðŸ§ª è°ƒè¯•å˜é‡:"
          Write-Host " - version: $version"
          Write-Host " - tag: $tag"
          Write-Host " - escaped: $escaped"
          Get-ChildItem "src-tauri/target/bundle-release/bundle/nsis" -Filter *.exe | ForEach-Object {
            $name = $_.Name
            Write-Host "ðŸ”Ž æ£€æŸ¥: $name"
            if ($name -match $escaped) {
              Write-Host "âœ… åŒ¹é…åˆ°ç‰ˆæœ¬å ä½: $escaped"
              $newName = $name -replace $escaped, "_${version}_${tag}_"
              Write-Host "âž¡ï¸  ç›®æ ‡æ–‡ä»¶å: $newName"
              if ($newName -ne $name) {
                Rename-Item -Path $_.FullName -NewName $newName
              }
            }
          }
          Write-Host "ðŸ—‚ï¸ é‡å‘½ååŽæ–‡ä»¶åˆ—è¡¨:"
          Get-ChildItem "src-tauri/target/bundle-release/bundle/nsis" -Filter *.exe |
            Select-Object -ExpandProperty Name |
            ForEach-Object { Write-Host " - $_" }

      - name: ðŸ“¤ ä¸Šä¼ å®‰è£…åŒ… (Artifacts)
        uses: actions/upload-artifact@v5
        with:
          name: mtga-${{ env.VERSION }}-windows
          if-no-files-found: error
          path: |
            src-tauri/target/bundle-release/bundle/nsis/*.exe

      - name: ðŸš€ åˆ›å»º/æ›´æ–° GitHub Release å¹¶ä¸Šä¼ å®‰è£…åŒ…
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $tag = "${{ env.VERSION }}"
          if (-not $tag) { throw "VERSION ä¸ºç©ºï¼Œæ— æ³•åˆ›å»º Release" }

          $isPrerelease = ("${{ github.event.inputs.prerelease }}" -eq "true")
          $isDraft = ("${{ github.event.inputs.draft }}" -eq "true")

          $files = Get-ChildItem "src-tauri/target/bundle-release/bundle/nsis" -Filter *.exe |
            Select-Object -ExpandProperty FullName

          if (-not $files) { throw "æœªæ‰¾åˆ°å®‰è£…åŒ…: src-tauri/target/bundle-release/bundle/nsis/*.exe" }

          $notes = "CI build from ${{ github.sha }} (branch: ${{ github.ref_name }})"

          gh release view $tag *> $null
          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… Release å·²å­˜åœ¨: $tagï¼Œæ›´æ–°èµ„äº§..."
            gh release upload $tag $files --clobber
            exit 0
          }

          Write-Host "ðŸ†• åˆ›å»º Release: $tag"
          $args = @("release", "create", $tag)
          $args += $files
          $args += @("--title", $tag, "--notes", $notes, "--target", "${{ github.sha }}")
          if ($isPrerelease) { $args += "--prerelease" }
          if ($isDraft) { $args += "--draft" }

          gh @args
