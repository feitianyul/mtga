name: ğŸš€ æ„å»ºå’Œå‘å¸ƒç‰ˆæœ¬(TAURI) - test win
on:
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.13"
  VERSION: "v2.0.0-test-win"

jobs:
  build-windows:
    name: ğŸªŸ æ„å»º Windows
    runs-on: windows-latest
    env:
      UV_CACHE_DIR: "${{ github.workspace }}\\.uv_cache"
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: ğŸ è®¾ç½® Python
        id: setup-python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸŸ¢ è®¾ç½® Node
        uses: actions/setup-node@v6
        with:
          node-version-file: package.json

      - name: ğŸ”§ å¯ç”¨ Corepack
        id: pnpm-store
        env:
          COREPACK_ENABLE_DOWNLOAD_PROMPT: "0"
        run: |
          corepack enable
          pnpm --version
          $store = pnpm store path --silent
          "pnpm_store_path=$store" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: ğŸ’¾ ç¼“å­˜ pnpm store
        uses: actions/cache@v5
        with:
          path: ${{ steps.pnpm-store.outputs.pnpm_store_path }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: ğŸ¦€ è®¾ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ§° ç¼“å­˜ Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            src-tauri
          shared-key: tauri-${{ runner.os }}-x64

      - name: ğŸ” è°ƒè¯• uv.lock
        run: |
          Get-Location
          if (Test-Path python-src/uv.lock) {
            Get-Item python-src/uv.lock | Format-List FullName,Length
            Get-Content python-src/uv.lock -TotalCount 5
          } else {
            Write-Host "python-src/uv.lock ä¸å­˜åœ¨"
          }

      - name: ğŸ§® è®¡ç®— uv.lock å“ˆå¸Œ
        id: uv-lock-hash
        run: |
          if (Test-Path python-src/uv.lock) {
            $hash = (Get-FileHash python-src/uv.lock -Algorithm SHA256).Hash
          } else {
            $hash = "missing"
            Write-Host "âš ï¸ uv.lock ä¸å­˜åœ¨ï¼Œç¼“å­˜ key ä½¿ç”¨ missing"
          }
          "hash=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: ğŸ’¾ ç¼“å­˜ uv ä¾èµ–
        uses: actions/cache@v5
        with:
          path: |
            python-src/.venv
            .uv_cache
            ${{ env.USERPROFILE }}\.local\bin\uv.exe
            ${{ env.USERPROFILE }}\.local\bin\uvx.exe
          key: ${{ runner.os }}-py-${{ steps.setup-python.outputs.python-version }}-uv-win-${{ steps.uv-lock-hash.outputs.hash }}
          restore-keys: |
            ${{ runner.os }}-py-${{ steps.setup-python.outputs.python-version }}-uv-win-

      - name: ğŸ“¦ å®‰è£… uv
        run: |
          $ErrorActionPreference = "Stop"
          $uvBinDir = Join-Path $env:USERPROFILE ".local\\bin"
          $env:PATH = "$uvBinDir;$env:PATH"
          $uvBinDir | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          for ($i = 1; $i -le 3; $i++) {
            if (Get-Command uv -ErrorAction SilentlyContinue) {
              break
            }
            Write-Host "ğŸ” å°è¯•å®‰è£… uvï¼ˆç¬¬ $i æ¬¡ï¼‰..."
            try {
              Invoke-WebRequest -Uri "https://astral.sh/uv/install.ps1" -OutFile "install.ps1"
              ./install.ps1
            } catch {
              Write-Host "âš ï¸ uv å®‰è£…è„šæœ¬æ‰§è¡Œå¤±è´¥: $($_.Exception.Message)"
            }
            Start-Sleep -Seconds (5 * $i)
          }

          if (-not (Get-Command uv -ErrorAction SilentlyContinue)) {
            throw "uv å®‰è£…å¤±è´¥ï¼ˆå¤šæ¬¡é‡è¯•åä»ä¸å¯ç”¨ï¼‰"
          }

          uv --version

      - name: ğŸ”§ åŒæ­¥ Python ä¾èµ–
        run: uv sync --project .
        working-directory: python-src

      - name: ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: ğŸ“¥ å‡†å¤‡ pyembed Python
        run: |
          $ErrorActionPreference = "Stop"
          $pyembedDir = "src-tauri/pyembed"
          New-Item -ItemType Directory -Path $pyembedDir -Force | Out-Null
          $assetUrl = gh api /repos/astral-sh/python-build-standalone/releases/latest `
            -H "Accept: application/vnd.github+json" `
            -H "X-GitHub-Api-Version: 2022-11-28" `
            --jq '.assets[] | select(.name | test("cpython-3\\.13\\..*\\+.*-x86_64-pc-windows-msvc-install_only_stripped\\.tar\\.gz")) | .browser_download_url' |
            Select-Object -First 1
          if (-not $assetUrl) { throw "âŒ æœªæ‰¾åˆ°åŒ¹é…çš„ Python æ„å»ºäº§ç‰©" }
          $archivePath = Join-Path $pyembedDir "python-standalone.tar.gz"
          Write-Host "â¬‡ï¸ ä¸‹è½½: $assetUrl"
          Invoke-WebRequest -Uri $assetUrl -OutFile $archivePath
          tar -xzf $archivePath -C $pyembedDir

      - name: ğŸ§¾ å†™å…¥ pyembed .env
        run: |
          $envDir = "src-tauri/pyembed/python/Lib"
          New-Item -ItemType Directory -Path $envDir -Force | Out-Null
          Copy-Item -Path ".env.example" -Destination (Join-Path $envDir ".env") -Force

      - name: ğŸ§© å®‰è£… pytauri ä¾èµ–
        run: pnpm pytauri:install:win
        working-directory: .

      - name: ğŸ§± æ‰“åŒ… Tauri
        run: pnpm tauri:bundle:win:ci
        working-directory: .

      - name: ğŸ·ï¸ è¾“å‡ºé‡å‘½åå‰å®‰è£…åŒ…åˆ—è¡¨
        run: |
          Write-Host "ğŸ—‚ï¸ é‡å‘½åå‰æ–‡ä»¶åˆ—è¡¨:"
          Get-ChildItem "src-tauri/target/bundle-release/bundle/nsis" -Filter *.exe |
            Select-Object -ExpandProperty Name |
            ForEach-Object { Write-Host " - $_" }
          $version = "${{ env.VERSION }}"
          $tag = "windows"
          $escaped = [regex]::Escape("_${version}_")
          Write-Host "ğŸ§ª è°ƒè¯•å˜é‡:"
          Write-Host " - version: $version"
          Write-Host " - tag: $tag"
          Write-Host " - escaped: $escaped"
          Get-ChildItem "src-tauri/target/bundle-release/bundle/nsis" -Filter *.exe | ForEach-Object {
            $name = $_.Name
            Write-Host "ğŸ” æ£€æŸ¥: $name"
            if ($name -match $escaped) {
              Write-Host "âœ… åŒ¹é…åˆ°ç‰ˆæœ¬å ä½: $escaped"
              $newName = $name -replace $escaped, "_${version}_${tag}_"
              Write-Host "â¡ï¸  ç›®æ ‡æ–‡ä»¶å: $newName"
              if ($newName -ne $name) {
                Rename-Item -Path $_.FullName -NewName $newName
              }
            }
          }
          Write-Host "ğŸ—‚ï¸ é‡å‘½ååæ–‡ä»¶åˆ—è¡¨:"
          Get-ChildItem "src-tauri/target/bundle-release/bundle/nsis" -Filter *.exe |
            Select-Object -ExpandProperty Name |
            ForEach-Object { Write-Host " - $_" }

      - name: ğŸ“¤ ä¸Šä¼ å®‰è£…åŒ… (Artifacts)
        uses: actions/upload-artifact@v5
        with:
          name: mtga-${{ env.VERSION }}-windows
          if-no-files-found: error
          path: |
            src-tauri/target/bundle-release/bundle/nsis/*.exe
