name: ğŸš€ æ„å»ºé¢„å‘å¸ƒç‰ˆæœ¬ (ä¿®å¤ç‰ˆ)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.2.0)'
        required: true
        default: '1.2.0'

env:
  PYTHON_VERSION: '3.13'

jobs:
  build-macos:
    name: ğŸ æ„å»º macOS ç‰ˆæœ¬
    runs-on: macos-latest
    strategy:
      matrix:
        arch: 
          # - x64
          - arm64
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ å®‰è£… uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          uv sync --extra mac-build

      # ç§»é™¤äº† Xcode Command Line Tools å®‰è£…æ­¥éª¤ï¼ŒGitHub Actions runner å·²é¢„è£…

      - name: âš™ï¸ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "APP_NAME=MTGA_GUI-v$VERSION-${{ matrix.arch }}" >> $GITHUB_OUTPUT
          echo "DMG_NAME=MTGA_GUI-v$VERSION-${{ matrix.arch }}" >> $GITHUB_OUTPUT

      - name: ğŸ”¨ æ„å»º macOS åº”ç”¨åŒ…
        run: |
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p dist-onefile
          
          # è®¾ç½®æ¶æ„å‚æ•°
          if [ "${{ matrix.arch }}" = "x86_64" ]; then
            ARCH_PARAM="--macos-target-arch=x86_64"
          else
            ARCH_PARAM="--macos-target-arch=arm64"
          fi
          
          echo "ğŸ” æ„å»ºä¿¡æ¯:"
          echo "ç‰ˆæœ¬: ${{ steps.version.outputs.VERSION }}"
          echo "æ¶æ„: ${{ matrix.arch }}"
          echo "æ¶æ„å‚æ•°: $ARCH_PARAM"
          
          # ç›´æ¥ä½¿ç”¨ Nuitka æ„å»ºï¼Œä¸ä¿®æ”¹è„šæœ¬æ–‡ä»¶
          uv run --python .venv/bin/python nuitka \
            --standalone \
            --macos-create-app-bundle \
            --show-progress \
            --show-memory \
            --output-dir=dist-onefile \
            --include-data-files=ca/README.md=ca/README.md \
            --include-data-files=ca/api.openai.com.cnf=ca/api.openai.com.cnf \
            --include-data-files=ca/api.openai.com.subj=ca/api.openai.com.subj \
            --include-data-files=ca/genca.sh=ca/genca.sh \
            --include-data-files=ca/gencrt.sh=ca/gencrt.sh \
            --include-data-files=ca/google.cnf=ca/google.cnf \
            --include-data-files=ca/google.subj=ca/google.subj \
            --include-data-files=ca/openssl.cnf=ca/openssl.cnf \
            --include-data-files=ca/pixiv.cnf=ca/pixiv.cnf \
            --include-data-files=ca/pixiv.subj=ca/pixiv.subj \
            --include-data-files=ca/v3_ca.cnf=ca/v3_ca.cnf \
            --include-data-files=ca/v3_req.cnf=ca/v3_req.cnf \
            --include-data-files=ca/youtube.cnf=ca/youtube.cnf \
            --include-data-files=ca/youtube.subj=ca/youtube.subj \
            --include-data-files=mac/MTGA_GUI_Launcher_Fixed=MTGA_GUI_Launcher_Fixed \
            --macos-app-icon=mac/icon.icns \
            --enable-plugin=tk-inter \
            $ARCH_PARAM \
            --remove-output \
            --disable-console \
            --include-package=modules \
            --macos-app-name="MTGA GUI" \
            --macos-app-version="${{ steps.version.outputs.VERSION }}" \
            mtga_gui.py
          
          # Nuitka æ€»æ˜¯ç”Ÿæˆ mtga_gui.appï¼Œéœ€è¦é‡å‘½å
          if [ -d "dist-onefile/mtga_gui.app" ]; then
            EXPECTED_NAME="${{ steps.version.outputs.APP_NAME }}.app"
            echo "ğŸ”„ é‡å‘½ååº”ç”¨åŒ…: mtga_gui.app â†’ $EXPECTED_NAME"
            mv "dist-onefile/mtga_gui.app" "dist-onefile/$EXPECTED_NAME"
            echo "âœ… é‡å‘½åå®Œæˆ"
          fi

      - name: ğŸ”§ é…ç½®åº”ç”¨åŒ…
        run: |
          APP_PATH="dist-onefile/${{ steps.version.outputs.APP_NAME }}.app"
          
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ åº”ç”¨åŒ…ä¸å­˜åœ¨: $APP_PATH"
            exit 1
          fi
          
          echo "ğŸ”§ é…ç½®å¯åŠ¨å™¨..."
          info_plist="$APP_PATH/Contents/Info.plist"
          if [ -f "$info_plist" ]; then
            # ä¿®æ”¹ CFBundleExecutable æŒ‡å‘å¯åŠ¨å™¨
            sed -i '' 's/<string>MTGA_GUI-v.*<\/string>/<string>MTGA_GUI_Launcher_Fixed<\/string>/g' "$info_plist"
            
            # ç¡®ä¿å¯åŠ¨å™¨æœ‰æ‰§è¡Œæƒé™
            chmod +x "$APP_PATH/Contents/MacOS/MTGA_GUI_Launcher_Fixed"
            
            echo "âœ… å¯åŠ¨å™¨é…ç½®å®Œæˆ"
          fi
          
          # é‡æ–°ç­¾ååº”ç”¨ä»¥ä¿®å¤å‰ªè´´æ¿æƒé™
          echo "ğŸ” é‡æ–°ç­¾ååº”ç”¨..."
          entitlements_path="mac/entitlements.plist"
          if [ -f "$entitlements_path" ]; then
            # ç­¾åå®é™…çš„äºŒè¿›åˆ¶æ–‡ä»¶
            binary_file="$APP_PATH/Contents/MacOS/MTGA_GUI-v${{ steps.version.outputs.VERSION }}-${{ matrix.arch }}"
            if [ -f "$binary_file" ]; then
              codesign --force --sign - --entitlements "$entitlements_path" "$binary_file" || echo "âš ï¸ äºŒè¿›åˆ¶æ–‡ä»¶ç­¾åå¤±è´¥"
            fi
            
            # ç„¶åç­¾åæ•´ä¸ªåº”ç”¨åŒ…
            if codesign --force --sign - --entitlements "$entitlements_path" "$APP_PATH"; then
              echo "âœ… åº”ç”¨ç­¾åå®Œæˆï¼ˆå·²ä¿®å¤å‰ªè´´æ¿æƒé™ï¼‰"
            else
              echo "âš ï¸ åº”ç”¨ç­¾åå¤±è´¥ï¼Œå‰ªè´´æ¿åŠŸèƒ½å¯èƒ½å—é™"
            fi
          else
            echo "âš ï¸ æƒé™æ–‡ä»¶ä¸å­˜åœ¨: $entitlements_path"
          fi

      - name: ğŸ“± éªŒè¯åº”ç”¨åŒ…
        run: |
          APP_PATH="dist-onefile/${{ steps.version.outputs.APP_NAME }}.app"
          
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ åº”ç”¨åŒ…ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… åº”ç”¨åŒ…æ„å»ºæˆåŠŸ: $APP_PATH"
          echo "ğŸ“Š åº”ç”¨åŒ…å¤§å°: $(du -sh "$APP_PATH" | cut -f1)"
          echo "ğŸ“ åº”ç”¨åŒ…ç»“æ„:"
          find "$APP_PATH" -maxdepth 2 -type d | head -10

      - name: ğŸ åˆ›å»º DMG å®‰è£…åŒ…
        run: |
          APP_PATH="dist-onefile/${{ steps.version.outputs.APP_NAME }}.app"
          DMG_PATH="dist-onefile/${{ steps.version.outputs.DMG_NAME }}.dmg"
          
          # ç¡®ä¿ DMG é…ç½®æ–‡ä»¶å­˜åœ¨
          if [ ! -f "mac/dmg_settings.py" ]; then
            echo "âŒ DMG é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: mac/dmg_settings.py"
            exit 1
          fi
          
          # ç¡®ä¿èƒŒæ™¯å›¾ç‰‡å­˜åœ¨
          if [ ! -f "mac/dmg_background.png" ]; then
            echo "âŒ DMG èƒŒæ™¯å›¾ç‰‡ä¸å­˜åœ¨: mac/dmg_background.png"
            exit 1
          fi
          
          echo "ğŸ“¦ åˆ›å»º DMG å®‰è£…åŒ…..."
          echo "åº”ç”¨åŒ…: $APP_PATH"
          echo "DMGæ–‡ä»¶: $DMG_PATH"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›DMGé…ç½®æ–‡ä»¶ä½¿ç”¨
          export MTGA_APP_NAME="$APP_PATH"
          echo "ğŸ”§ è®¾ç½® DMG åº”ç”¨è·¯å¾„: $MTGA_APP_NAME"
          
          # åˆ›å»º DMG
          uv run dmgbuild \
            -s mac/dmg_settings.py \
            "MTGA GUI v${{ steps.version.outputs.VERSION }} Installer" \
            "$DMG_PATH"
          
          if [ -f "$DMG_PATH" ]; then
            echo "âœ… DMG åˆ›å»ºæˆåŠŸ"
            echo "ğŸ“Š DMG å¤§å°: $(du -sh "$DMG_PATH" | cut -f1)"
          else
            echo "âŒ DMG åˆ›å»ºå¤±è´¥"
            exit 1
          fi

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: MTGA-GUI-${{ matrix.arch }}-${{ steps.version.outputs.VERSION }}
          path: |
            dist-onefile/${{ steps.version.outputs.APP_NAME }}.app
            dist-onefile/${{ steps.version.outputs.DMG_NAME }}.dmg
          retention-days: 30

      - name: ğŸ“‹ æ„å»ºæ€»ç»“
        run: |
          echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
          echo ""
          echo "ğŸ“± åº”ç”¨åŒ…: dist-onefile/${{ steps.version.outputs.APP_NAME }}.app"
          echo "ğŸ’¿ DMGå®‰è£…åŒ…: dist-onefile/${{ steps.version.outputs.DMG_NAME }}.dmg"
          echo ""
          echo "ğŸ“Š æ–‡ä»¶å¤§å°:"
          ls -lh dist-onefile/