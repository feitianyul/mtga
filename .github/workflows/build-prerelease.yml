name: ğŸš€ æ„å»ºå’Œå‘å¸ƒé¢„å‘å¸ƒç‰ˆ

on:
  push:
    tags:
      - 'v*.*.*-*'  # é¢„å‘å¸ƒç‰ˆæ ‡ç­¾æ ¼å¼ï¼šv1.2.0-beta.1, v1.2.0-rc.1
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.2.0-beta.1)'
        required: true
        default: '1.2.0-beta.1'

env:
  PYTHON_VERSION: '3.13'

jobs:
  build-macos:
    name: ğŸ æ„å»º macOS
    runs-on: macos-latest
    strategy:
      matrix:
        arch: 
          # - x64
          - arm64
        include:
          # - arch: x64
          #   runner_arch: x86_64
          #   nuitka_arch: x86_64
          - arch: arm64  
            runner_arch: arm64
            nuitka_arch: arm64

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ å®‰è£… uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          uv sync --extra mac-build

      - name: ğŸ› ï¸ å®‰è£… Xcode Command Line Tools
        run: |
          sudo xcode-select --install || true
          # ç­‰å¾…å®‰è£…å®Œæˆæˆ–è·³è¿‡å¦‚æœå·²å®‰è£…
          while ! xcode-select -p &>/dev/null; do
            echo "ç­‰å¾… Xcode Command Line Tools å®‰è£…..."
            sleep 10
          done

      - name: âš™ï¸ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "APP_NAME=mtga_gui" >> $GITHUB_OUTPUT
          echo "DMG_NAME=MTGA_GUI-v$VERSION-${{ matrix.arch }}" >> $GITHUB_OUTPUT

      - name: ğŸ”¨ æ„å»º macOS åº”ç”¨åŒ…
        run: |
          # ä¿®æ”¹æ„å»ºè„šæœ¬ä¸­çš„ç‰ˆæœ¬å·
          sed -i.bak "s/VERSION=\".*\"/VERSION=\"${{ steps.version.outputs.VERSION }}\"/g" build_mac_app.sh
          
          # æ ¹æ®æ¶æ„è®¾ç½®è¾“å‡ºæ–‡ä»¶åï¼Œæ›¿æ¢ $(uname -m) ä¸ºå…·ä½“æ¶æ„
          sed -i.bak "s/\$(uname -m)/${{ matrix.arch }}/g" build_mac_app.sh
          
          # æ˜¾ç¤ºä¿®æ”¹åçš„æ„å»ºè„šæœ¬ç›¸å…³è¡Œï¼Œç”¨äºè°ƒè¯•
          echo "ğŸ” æ£€æŸ¥ä¿®æ”¹åçš„æ„å»ºè„šæœ¬:"
          echo "VERSION è¡Œ:"
          grep "VERSION=" build_mac_app.sh | head -1
          echo "output-filename è¡Œ:"
          grep "output-filename" build_mac_app.sh
          
          # æ‰§è¡Œæ„å»º
          chmod +x build_mac_app.sh
          ./build_mac_app.sh
          
          # Nuitka åœ¨ macOS åº”ç”¨åŒ…æ¨¡å¼ä¸‹å¿½ç•¥ --output-filenameï¼Œæ€»æ˜¯ä½¿ç”¨æºæ–‡ä»¶å
          # éœ€è¦æ‰‹åŠ¨é‡å‘½ååˆ°æœŸæœ›çš„æ–‡ä»¶å
          # if [ -d "dist-onefile/mtga_gui.app" ]; then
          #   EXPECTED_NAME="${{ steps.version.outputs.APP_NAME }}.app"
          #   echo "ğŸ”„ é‡å‘½ååº”ç”¨åŒ…: mtga_gui.app â†’ $EXPECTED_NAME"
          #   mv "dist-onefile/mtga_gui.app" "dist-onefile/$EXPECTED_NAME"
          #   echo "âœ… é‡å‘½åå®Œæˆ"
          # fi

      - name: ğŸ“± éªŒè¯åº”ç”¨åŒ…
        run: |
          echo "ğŸ” æ£€æŸ¥ dist-onefile ç›®å½•å†…å®¹:"
          ls -la dist-onefile/ || echo "âŒ dist-onefile ç›®å½•ä¸å­˜åœ¨"
          
          # æŸ¥æ‰¾å®é™…ç”Ÿæˆçš„ .app æ–‡ä»¶
          APP_FILES=(dist-onefile/*.app)
          if [ ! -e "${APP_FILES[0]}" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ° .app æ–‡ä»¶"
            echo "ğŸ“ å½“å‰ç›®å½•ç»“æ„:"
            find dist-onefile/ -type f -name "*.app" 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°ä»»ä½• .app æ–‡ä»¶"
            exit 1
          fi
          
          # ä½¿ç”¨æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ª .app æ–‡ä»¶
          ACTUAL_APP_PATH="${APP_FILES[0]}"
          echo "âœ… åº”ç”¨åŒ…æ„å»ºæˆåŠŸ: $ACTUAL_APP_PATH"
          echo "ğŸ“Š åº”ç”¨åŒ…å¤§å°: $(du -sh "$ACTUAL_APP_PATH" | cut -f1)"
          echo "ğŸ“ åº”ç”¨åŒ…ç»“æ„:"
          find "$ACTUAL_APP_PATH" -maxdepth 2 -type d | head -10
          
          # æ£€æŸ¥æœŸæœ›çš„æ–‡ä»¶åæ˜¯å¦åŒ¹é…
          EXPECTED_PATH="dist-onefile/${{ steps.version.outputs.APP_NAME }}.app"
          if [ "$ACTUAL_APP_PATH" != "$EXPECTED_PATH" ]; then
            echo "âš ï¸ è­¦å‘Š: å®é™…æ–‡ä»¶åä¸æœŸæœ›ä¸ç¬¦"
            echo "æœŸæœ›: $EXPECTED_PATH"
            echo "å®é™…: $ACTUAL_APP_PATH"
          fi

      - name: ğŸ åˆ›å»º DMG å®‰è£…åŒ…
        run: |
          # ç¡®ä¿ DMG é…ç½®æ–‡ä»¶å­˜åœ¨
          if [ ! -f "mac/dmg_settings.py" ]; then
            echo "âŒ DMG é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: mac/dmg_settings.py"
            exit 1
          fi
          
          # æŸ¥æ‰¾å®é™…çš„ .app æ–‡ä»¶
          APP_FILES=(dist-onefile/*.app)
          if [ ! -e "${APP_FILES[0]}" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ° .app æ–‡ä»¶ç”¨äºåˆ›å»º DMG"
            exit 1
          fi
          
          ACTUAL_APP_PATH="${APP_FILES[0]}"
          
          echo "ğŸ“¦ ä½¿ç”¨åº”ç”¨åŒ…: $ACTUAL_APP_PATH"
          echo "ğŸ“¦ DMG æ–‡ä»¶å: ${{ steps.version.outputs.DMG_NAME }}.dmg"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›DMGé…ç½®æ–‡ä»¶ä½¿ç”¨ï¼ŒåŒ…å«å®Œæ•´è·¯å¾„
          export MTGA_APP_NAME="$ACTUAL_APP_PATH"
          echo "ğŸ”§ è®¾ç½® DMG åº”ç”¨è·¯å¾„: $MTGA_APP_NAME"
          
          # åˆ›å»º DMG
          uv run dmgbuild \
            -s mac/dmg_settings.py \
            "MTGA GUI v${{ steps.version.outputs.VERSION }} Installer" \
            "dist-onefile/${{ steps.version.outputs.DMG_NAME }}.dmg"
          
          echo "âœ… DMG åˆ›å»ºæˆåŠŸ"
          echo "ğŸ“Š DMG å¤§å°: $(du -sh "dist-onefile/${{ steps.version.outputs.DMG_NAME }}.dmg" | cut -f1)"

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-artifacts
          path: |
            dist-onefile/*.app
            dist-onefile/*.dmg
          retention-days: 7

  # Windows æ„å»ºä»»åŠ¡ï¼ˆé¢„ç•™æ¡†æ¶ï¼‰
  build-windows:
    name: ğŸªŸ æ„å»º Windows
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ å®‰è£… uv
        run: |
          Invoke-WebRequest -Uri "https://astral.sh/uv/install.ps1" -OutFile "install.ps1"
          ./install.ps1
          echo "$env:USERPROFILE\.local\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          uv sync --extra win-build

      - name: ğŸ” æ£€æŸ¥ Visual Studio
        run: |
          $vs2022Path = "C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build"
          if (Test-Path $vs2022Path) {
            Write-Host "âœ… æ‰¾åˆ° Visual Studio 2022: $vs2022Path"
          } else {
            Write-Host "âŒ æœªæ‰¾åˆ° Visual Studio 2022ï¼Œå°è¯•ä½¿ç”¨å…¶ä»–ç‰ˆæœ¬"
            $vsPath = "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build"
            if (Test-Path $vsPath) {
              Write-Host "âœ… æ‰¾åˆ° Visual Studio 2019: $vsPath"
            } else {
              Write-Host "âŒ æœªæ‰¾åˆ° Visual Studioï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨é…ç½® MSVC"
            }
          }

      - name: âš™ï¸ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $VERSION = "${{ github.event.inputs.version }}"
          } else {
            $VERSION = "${{ github.ref }}" -replace "refs/tags/v", ""
          }
          echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT
          echo "EXE_NAME=MTGA_GUI-v$VERSION-x64.exe" >> $env:GITHUB_OUTPUT

      - name: ğŸ”¨ æ„å»º Windows å•æ–‡ä»¶ç‰ˆæœ¬
        run: |
          # ä¿®æ”¹æ„å»ºè„šæœ¬ä¸­çš„ç‰ˆæœ¬å·
          $content = Get-Content "build_onefile.bat"
          $content = $content -replace 'set "VERSION=.*"', "set `"VERSION=${{ steps.version.outputs.VERSION }}`""
          $content | Set-Content "build_onefile.bat"

          # æ˜¾ç¤ºä¿®æ”¹åçš„ç‰ˆæœ¬å·
          Write-Host "ğŸ” æ£€æŸ¥ä¿®æ”¹åçš„æ„å»ºè„šæœ¬:"
          Select-String -Path "build_onefile.bat" -Pattern "VERSION=" | Select-Object -First 1

          # æ‰§è¡Œæ„å»º
          try {
            .\build_onefile.bat
            Write-Host "âœ… æ„å»ºè„šæœ¬æ‰§è¡Œå®Œæˆ"
          } catch {
            Write-Host "âŒ æ„å»ºå¤±è´¥: $_"
            exit 1
          }

      - name: ğŸ“± éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          $exePath = "dist-onefile\${{ steps.version.outputs.EXE_NAME }}"
          if (Test-Path $exePath) {
            $size = (Get-Item $exePath).Length / 1MB
            Write-Host "âœ… Windows å¯æ‰§è¡Œæ–‡ä»¶æ„å»ºæˆåŠŸ: $exePath"
            Write-Host "ğŸ“Š æ–‡ä»¶å¤§å°: $([math]::Round($size, 2)) MB"

            # éªŒè¯æ–‡ä»¶æ ¼å¼
            $fileInfo = Get-Item $exePath
            Write-Host "ğŸ“‹ æ–‡ä»¶ä¿¡æ¯:"
            Write-Host "  - åˆ›å»ºæ—¶é—´: $($fileInfo.CreationTime)"
            Write-Host "  - ä¿®æ”¹æ—¶é—´: $($fileInfo.LastWriteTime)"
            Write-Host "  - æ–‡ä»¶å±æ€§: $($fileInfo.Attributes)"
          } else {
            Write-Host "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: $exePath"
            Write-Host "ğŸ“ dist-onefile ç›®å½•å†…å®¹:"
            if (Test-Path "dist-onefile") {
              Get-ChildItem -Path "dist-onefile" -Recurse | ForEach-Object {
                Write-Host "  $($_.FullName) ($([math]::Round($_.Length/1MB, 2)) MB)"
              }
            } else {
              Write-Host "  dist-onefile ç›®å½•ä¸å­˜åœ¨"
            }
            exit 1
          }

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            dist-onefile/*.exe
          retention-days: 7

  create-prerelease:
    name: ğŸš€ åˆ›å»ºé¢„å‘å¸ƒç‰ˆ
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: âš™ï¸ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG_NAME="v$VERSION"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            TAG_NAME=${GITHUB_REF#refs/tags/}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“‹ åˆ—å‡ºæ„å»ºäº§ç‰©
        run: |
          echo "ğŸ—‚ï¸ æ„å»ºäº§ç‰©åˆ—è¡¨:"
          find artifacts -type f -name "*.app" -o -name "*.dmg" -o -name "*.exe" | sort

      - name: ğŸ·ï¸ åˆ›å»ºæˆ–æ›´æ–°æ ‡ç­¾
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # åˆ é™¤å·²å­˜åœ¨çš„æ ‡ç­¾ï¼ˆå¦‚æœæœ‰ï¼‰
          git tag -d ${{ steps.version.outputs.TAG_NAME }} || true
          git push origin :refs/tags/${{ steps.version.outputs.TAG_NAME }} || true
          
          # åˆ›å»ºæ–°æ ‡ç­¾
          git tag -a ${{ steps.version.outputs.TAG_NAME }} -m "ğŸš€ é¢„å‘å¸ƒç‰ˆ ${{ steps.version.outputs.VERSION }}"
          git push origin ${{ steps.version.outputs.TAG_NAME }}

      - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
        id: release_notes
        run: |
          # æ”¶é›†ç‰ˆæœ¬ä¸æ—¶é—´ä¿¡æ¯ï¼Œåç»­ç”¨äºæ›¿æ¢æ¨¡æ¿å˜é‡
          VERSION="${{ steps.version.outputs.VERSION }}"
          PYTHON_VER="${{ env.PYTHON_VERSION }}"
          COMMIT_SHA="${{ github.sha }}"
          REPO_SLUG="${{ github.repository }}"
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # æ£€ç´¢æ„å»ºäº§ç‰©ä»¥ä¾¿æŒ‰å®é™…å¹³å°ç”Ÿæˆä¸‹è½½è¯´æ˜
          WINDOWS_EXE=$(find artifacts -type f -name "*.exe" | head -n 1 || true)
          ARM_DMG=$(find artifacts -type f -name "*arm64.dmg" | head -n 1 || true)
          X64_DMG=$(find artifacts -type f -name "*x64.dmg" | head -n 1 || true)
          WIN_NAME=""
          ARM_NAME=""
          X64_NAME=""
          if [ -n "$WINDOWS_EXE" ]; then
            WIN_NAME=$(basename "$WINDOWS_EXE")
          fi
          if [ -n "$ARM_DMG" ]; then
            ARM_NAME=$(basename "$ARM_DMG")
          fi
          if [ -n "$X64_DMG" ]; then
            X64_NAME=$(basename "$X64_DMG")
          fi

          # å†™å…¥å…¬å…±éƒ¨åˆ†
          cat > release_notes.md <<EOF
          ## ğŸš€ MTGA GUI v${VERSION} (é¢„å‘å¸ƒç‰ˆ)

          > âš ï¸ **è¿™æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„åŠŸèƒ½ï¼Œè¯·è°¨æ…åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚**

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜

          #### Windows ç”¨æˆ·
          EOF

          if [ -n "$WIN_NAME" ]; then
            echo "- ä¸‹è½½ \`$WIN_NAME\` å¹¶åŒå‡»è¿è¡Œï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰" >> release_notes.md
          else
            echo "- æš‚æ— å¯ä¸‹è½½çš„ Windows é¢„å‘å¸ƒåŒ…" >> release_notes.md
          fi

          # ä»…åœ¨å­˜åœ¨å¯¹åº”åŒ…æ—¶å†™å…¥ macOS å¹³å°æŒ‡å¼•
          if [ -n "$ARM_NAME" ] || [ -n "$X64_NAME" ]; then
            {
              echo
              echo "#### macOS ç”¨æˆ·"
              if [ -n "$X64_NAME" ]; then
                echo "- **Intel Mac**: ä¸‹è½½ \`$X64_NAME\`"
              fi
              if [ -n "$ARM_NAME" ]; then
                echo "- **Apple Silicon Mac**: ä¸‹è½½ \`$ARM_NAME\`"
              fi
            } >> release_notes.md
          else
            {
              echo
              echo "#### macOS ç”¨æˆ·"
              echo "- æš‚æ— å¯ä¸‹è½½çš„ macOS é¢„å‘å¸ƒåŒ…"
            } >> release_notes.md
          fi

          cat >> release_notes.md <<EOF

          #### å®‰è£…æ–¹æ³•
          **Windows:**
          1. ä¸‹è½½ \`$WIN_NAME\` æ–‡ä»¶
          2. åŒå‡»è¿è¡Œï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
          3. åœ¨å›¾å½¢ç•Œé¢ä¸­é…ç½® API URL å’Œæ¨¡å‹ ID
          4. ç‚¹å‡»"ä¸€é”®å¯åŠ¨å…¨éƒ¨æœåŠ¡"

          **macOS:**
          1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ DMG æ–‡ä»¶
          2. åŒå‡» DMG æ–‡ä»¶æŒ‚è½½å®‰è£…åŒ…
          3. å°† `MTGA GUI.app` æ‹–æ‹½åˆ° `Applications` æ–‡ä»¶å¤¹
          4. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸è¿è¡Œ

          ### ğŸ”§ æŠ€æœ¯ä¿¡æ¯
          - Python ç‰ˆæœ¬: ${PYTHON_VER}
          - æ„å»ºæ—¶é—´: ${BUILD_TIME}
          - æäº¤å“ˆå¸Œ: ${COMMIT_SHA}

          ### ğŸ› é—®é¢˜åé¦ˆ
          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [GitHub Issues](https://github.com/${REPO_SLUG}/issues) ä¸­åé¦ˆã€‚
          EOF

          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸš€ åˆ›å»º GitHub é¢„å‘å¸ƒç‰ˆ
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.version.outputs.TAG_NAME }}
          name: "ğŸš€ MTGA GUI v${{ steps.version.outputs.VERSION }}"
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          prerelease: true
          draft: false
          artifacts: |
            artifacts/windows-artifacts/*.exe
            artifacts/macos-x64-artifacts/*.dmg
            artifacts/macos-arm64-artifacts/*.dmg
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… å‘å¸ƒå®Œæˆ
        run: |
          echo "ğŸ‰ é¢„å‘å¸ƒç‰ˆ v${{ steps.version.outputs.VERSION }} å‘å¸ƒå®Œæˆ!"
          echo "ğŸ”— å‘å¸ƒé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.TAG_NAME }}"
