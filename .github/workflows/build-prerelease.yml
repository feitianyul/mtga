name: ğŸš€ æ„å»ºå’Œå‘å¸ƒç‰ˆæœ¬

on:
  push:
    tags:
      - "v*.*.*-*"  # é¢„å‘å¸ƒç‰ˆæ ‡ç­¾æ ¼å¼ï¼šv1.2.0-beta.1, v1.2.0-rc.1
      - "v*.*.*"  # æ­£å¼ç‰ˆæ ‡ç­¾ï¼šv1.2.0
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.2.0-beta.1)"
        required: false
        default: "1.2.0-beta.1"
      release_type:
        description: "å‘å¸ƒç±»å‹"
        required: true
        default: "prerelease"
        type: choice
        options:
          - prerelease
          - release
      start_commit:
        description: >-
          èµ·å§‹æäº¤å“ˆå¸Œï¼ˆç¤ºä¾‹ï¼š
          1234567890abcdef1234567890abcdef12345678ï¼‰
        required: false
        default: ""

env:
  PYTHON_VERSION: "3.13"

jobs:
  build-macos:
    name: ğŸ æ„å»º macOS
    runs-on: macos-latest
    strategy:
      matrix:
        arch:
          # - x64
          - arm64
        include:
          # - arch: x64
          #   runner_arch: x86_64
          #   nuitka_arch: x86_64
          - arch: arm64
            runner_arch: arm64
            nuitka_arch: arm64

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ å®‰è£… uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: ğŸ’¾ ç¼“å­˜ uv ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ matrix.arch }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-${{ matrix.arch }}-

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          uv sync --group mac-build

      - name: ğŸ’¾ ç¼“å­˜ Nuitka å·¥å…·
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/Nuitka
            ~/.cache/nuitka
          key: ${{ runner.os }}-nuitka-${{ matrix.arch }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-${{ matrix.arch }}-
      - name: ğŸ› ï¸ å®‰è£… Xcode Command Line Tools
        run: |
          sudo xcode-select --install || true
          # ç­‰å¾…å®‰è£…å®Œæˆæˆ–è·³è¿‡å¦‚æœå·²å®‰è£…
          while ! xcode-select -p &>/dev/null; do
            echo "ç­‰å¾… Xcode Command Line Tools å®‰è£…..."
            sleep 10
          done

      - name: âš™ï¸ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.version }}" ]; then
              VERSION="${{ github.event.inputs.version }}"
            elif command -v python3 >/dev/null 2>&1; then
              PY_VERSION_SCRIPT=$'import tomllib\n'\
                $'from pathlib import Path\n\n'\
                $'pyproject = Path("pyproject.toml")\n'\
                $'data = tomllib.loads(pyproject.read_text(encoding="utf-8"))\n'\
                $'version = data.get("project", {}).get("version")\n'\
                $'if not version:\n'\
                $'    raise SystemExit("Missing project.version")\n'\
                $'print(version)'
              VERSION=$(python3 -c "$PY_VERSION_SCRIPT")
            else
              echo "âŒ æ— æ³•è§£æ pyproject.tomlï¼Œè¯·åœ¨ workflow_dispatch ä¸­æä¾›ç‰ˆæœ¬å·"
              exit 1
            fi
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "APP_NAME=mtga_gui" >> $GITHUB_OUTPUT
          echo "DMG_NAME=MTGA_GUI-v$VERSION-${{ matrix.arch }}" >> $GITHUB_OUTPUT

      - name: ğŸ”¨ æ„å»º macOS åº”ç”¨åŒ…
        run: |
          # ä¿®æ”¹æ„å»ºè„šæœ¬ä¸­çš„ç‰ˆæœ¬å·
          sed -i.bak \
            "s/VERSION=\".*\"/VERSION=\"${{ steps.version.outputs.VERSION }}\"/g" \
            build_mac_app.sh

          # æ ¹æ®æ¶æ„è®¾ç½®è¾“å‡ºæ–‡ä»¶åï¼Œæ›¿æ¢ $(uname -m) ä¸ºå…·ä½“æ¶æ„
          sed -i.bak "s/\$(uname -m)/${{ matrix.arch }}/g" build_mac_app.sh

          # æ˜¾ç¤ºä¿®æ”¹åçš„æ„å»ºè„šæœ¬ç›¸å…³è¡Œï¼Œç”¨äºè°ƒè¯•
          echo "ğŸ” æ£€æŸ¥ä¿®æ”¹åçš„æ„å»ºè„šæœ¬:"
          echo "VERSION è¡Œ:"
          grep "VERSION=" build_mac_app.sh | head -1
          echo "output-filename è¡Œ:"
          grep "output-filename" build_mac_app.sh

          # æ‰§è¡Œæ„å»º
          chmod +x build_mac_app.sh
          ./build_mac_app.sh

          # Nuitka åœ¨ macOS åº”ç”¨åŒ…æ¨¡å¼ä¸‹å¿½ç•¥ --output-filenameï¼Œæ€»æ˜¯ä½¿ç”¨æºæ–‡ä»¶å
          # éœ€è¦æ‰‹åŠ¨é‡å‘½ååˆ°æœŸæœ›çš„æ–‡ä»¶å
          # if [ -d "dist-onefile/mtga_gui.app" ]; then
          #   EXPECTED_NAME="${{ steps.version.outputs.APP_NAME }}.app"
          #   echo "ğŸ”„ é‡å‘½ååº”ç”¨åŒ…: mtga_gui.app â†’ $EXPECTED_NAME"
          #   mv "dist-onefile/mtga_gui.app" "dist-onefile/$EXPECTED_NAME"
          #   echo "âœ… é‡å‘½åå®Œæˆ"
          # fi

      - name: ğŸ“± éªŒè¯åº”ç”¨åŒ…
        run: |
          echo "ğŸ” æ£€æŸ¥ dist-onefile ç›®å½•å†…å®¹:"
          ls -la dist-onefile/ || echo "âŒ dist-onefile ç›®å½•ä¸å­˜åœ¨"

          # æŸ¥æ‰¾å®é™…ç”Ÿæˆçš„ .app æ–‡ä»¶
          APP_FILES=(dist-onefile/*.app)
          if [ ! -e "${APP_FILES[0]}" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ° .app æ–‡ä»¶"
            echo "ğŸ“ å½“å‰ç›®å½•ç»“æ„:"
            find dist-onefile/ -type f -name "*.app" 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°ä»»ä½• .app æ–‡ä»¶"
            exit 1
          fi

          # ä½¿ç”¨æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ª .app æ–‡ä»¶
          ACTUAL_APP_PATH="${APP_FILES[0]}"
          echo "âœ… åº”ç”¨åŒ…æ„å»ºæˆåŠŸ: $ACTUAL_APP_PATH"
          echo "ğŸ“Š åº”ç”¨åŒ…å¤§å°: $(du -sh "$ACTUAL_APP_PATH" | cut -f1)"
          echo "ğŸ“ åº”ç”¨åŒ…ç»“æ„:"
          find "$ACTUAL_APP_PATH" -maxdepth 2 -type d | head -10

          # æ£€æŸ¥æœŸæœ›çš„æ–‡ä»¶åæ˜¯å¦åŒ¹é…
          EXPECTED_PATH="dist-onefile/${{ steps.version.outputs.APP_NAME }}.app"
          if [ "$ACTUAL_APP_PATH" != "$EXPECTED_PATH" ]; then
            echo "âš ï¸ è­¦å‘Š: å®é™…æ–‡ä»¶åä¸æœŸæœ›ä¸ç¬¦"
            echo "æœŸæœ›: $EXPECTED_PATH"
            echo "å®é™…: $ACTUAL_APP_PATH"
          fi

      - name: ğŸ åˆ›å»º DMG å®‰è£…åŒ…
        run: |
          # ç¡®ä¿ DMG é…ç½®æ–‡ä»¶å­˜åœ¨
          if [ ! -f "mac/dmg_settings.py" ]; then
            echo "âŒ DMG é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: mac/dmg_settings.py"
            exit 1
          fi

          # æŸ¥æ‰¾å®é™…çš„ .app æ–‡ä»¶
          APP_FILES=(dist-onefile/*.app)
          if [ ! -e "${APP_FILES[0]}" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ° .app æ–‡ä»¶ç”¨äºåˆ›å»º DMG"
            exit 1
          fi

          ACTUAL_APP_PATH="${APP_FILES[0]}"

          DMG_PATH="dist-onefile/${{ steps.version.outputs.DMG_NAME }}.dmg"

          echo "ğŸ“¦ ä½¿ç”¨åº”ç”¨åŒ…: $ACTUAL_APP_PATH"
          echo "ğŸ“¦ DMG æ–‡ä»¶å: ${{ steps.version.outputs.DMG_NAME }}.dmg"

          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›DMGé…ç½®æ–‡ä»¶ä½¿ç”¨ï¼ŒåŒ…å«å®Œæ•´è·¯å¾„
          export MTGA_APP_NAME="$ACTUAL_APP_PATH"
          echo "ğŸ”§ è®¾ç½® DMG åº”ç”¨è·¯å¾„: $MTGA_APP_NAME"

          # åˆ›å»º DMG
          uv run dmgbuild \
            -s mac/dmg_settings.py \
            "MTGA GUI v${{ steps.version.outputs.VERSION }} Installer" \
            "$DMG_PATH"

          echo "âœ… DMG åˆ›å»ºæˆåŠŸ"
          DMG_SIZE=$(du -sh "$DMG_PATH" | cut -f1)
          echo "ğŸ“Š DMG å¤§å°: $DMG_SIZE"

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-artifacts
          path: |
            dist-onefile/*.app
            dist-onefile/*.dmg
          retention-days: 7

  # Windows æ„å»ºä»»åŠ¡ï¼ˆé¢„ç•™æ¡†æ¶ï¼‰
  build-windows:
    name: ğŸªŸ æ„å»º Windows
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ å®‰è£… uv
        run: |
          Invoke-WebRequest -Uri "https://astral.sh/uv/install.ps1" -OutFile "install.ps1"
          ./install.ps1
          echo "$env:USERPROFILE\.local\bin" |
            Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      - name: ğŸ’¾ ç¼“å­˜ uv ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ${{ env.USERPROFILE }}\.cache\uv
          key: ${{ runner.os }}-uv-win-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-win-

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          uv sync --group win-build

      - name: ğŸ’¾ ç¼“å­˜ Nuitka å·¥å…·
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.USERPROFILE }}\AppData\Local\Nuitka
          key: ${{ runner.os }}-nuitka-win-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-win-

      - name: ğŸ” æ£€æŸ¥ Visual Studio
        run: |
          $vcBuildDir = $null
          $vswhereBase = ${env:ProgramFiles(x86)}
          $vsInstallerPath = "Microsoft Visual Studio\Installer\vswhere.exe"
          $vswherePath = Join-Path $vswhereBase $vsInstallerPath
          if (Test-Path $vswherePath) {
            try {
              $vswhereArgs = @(
                '-latest'
                '-products'
                '*'
                '-requires'
                'Microsoft.VisualStudio.Component.VC.Tools.x86.x64'
                '-property'
                'installationPath'
              )
              $installationPath = & $vswherePath @vswhereArgs
              if ($installationPath) {
                $candidate = Join-Path $installationPath "VC\Auxiliary\Build"
                if (Test-Path $candidate) {
                  $vcBuildDir = $candidate
                }
              }
            } catch {
              Write-Host "âš ï¸ vswhere æ£€æµ‹å¤±è´¥: $_"
            }
          }

          if (-not $vcBuildDir) {
            $fallbackPaths = @(
              "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build",
              "C:\Program Files\Microsoft Visual Studio\2022\Professional\VC\Auxiliary\Build",
              "C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build",
              "C:\Program Files\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build",
              "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build",
              "C:\Program Files (x86)\Microsoft Visual Studio\2019\Professional\VC\Auxiliary\Build",
              "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build",
              "C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Auxiliary\Build"
            )

            foreach ($path in $fallbackPaths) {
              if (Test-Path $path) {
                $vcBuildDir = $path
                break
              }
            }
          }

          if ($vcBuildDir) {
            Write-Host "âœ… æ‰¾åˆ°å¯ç”¨çš„ MSVC ç¯å¢ƒ: $vcBuildDir"
            "VC_BUILD_DIR=$vcBuildDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            Write-Host "âŒ æœªæ‰¾åˆ°ä»»ä½•å·²å®‰è£…çš„ Visual Studio MSVC ç¯å¢ƒï¼Œåç»­æ„å»ºå¯èƒ½å¤±è´¥"
          }

      - name: âš™ï¸ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $VERSION = "${{ github.event.inputs.version }}"
          } else {
            $VERSION = "${{ github.ref }}" -replace "refs/tags/v", ""
          }
          echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT
          echo "EXE_NAME=MTGA_GUI-v$VERSION-x64.exe" >> $env:GITHUB_OUTPUT

      - name: ğŸ”¨ æ„å»º Windows å•æ–‡ä»¶ç‰ˆæœ¬
        run: |
          # ä¿®æ”¹æ„å»ºè„šæœ¬ä¸­çš„ç‰ˆæœ¬å·
          $content = Get-Content "build_onefile.bat"
          $pattern = 'set "VERSION=.*"'
          $newVersionLine = "set `"VERSION=${{ steps.version.outputs.VERSION }}`""
          $content = $content -replace $pattern, $newVersionLine
          $content | Set-Content "build_onefile.bat"

          # æ˜¾ç¤ºä¿®æ”¹åçš„ç‰ˆæœ¬å·
          Write-Host "ğŸ” æ£€æŸ¥ä¿®æ”¹åçš„æ„å»ºè„šæœ¬:"
          Select-String -Path "build_onefile.bat" -Pattern "VERSION=" | Select-Object -First 1

          # æ‰§è¡Œæ„å»º
          try {
            if ($env:VC_BUILD_DIR) {
              Write-Host "â„¹ï¸ ä¼ é€’æ£€æµ‹åˆ°çš„ MSVC ç›®å½•: $env:VC_BUILD_DIR"
              & .\build_onefile.bat "$env:VC_BUILD_DIR"
            } else {
              & .\build_onefile.bat
            }
            Write-Host "âœ… æ„å»ºè„šæœ¬æ‰§è¡Œå®Œæˆ"
          } catch {
            Write-Host "âŒ æ„å»ºå¤±è´¥: $_"
            exit 1
          }

      - name: ğŸ“± éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          $expectedName = "${{ steps.version.outputs.EXE_NAME }}"
          $expectedPath = Join-Path "dist-onefile" $expectedName

          if (-not (Test-Path "dist-onefile")) {
            Write-Host "âŒ dist-onefile ç›®å½•ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰¾åˆ°æ„å»ºäº§ç‰©"
            exit 1
          }

          if (-not (Test-Path $expectedPath)) {
            $latestExe = Get-ChildItem -Path "dist-onefile" -Filter *.exe -File `
              -ErrorAction SilentlyContinue |
              Sort-Object LastWriteTime -Descending |
              Select-Object -First 1
            if ($latestExe) {
              Write-Host "âš ï¸ å‘ç°æœªå‘½åä¸ºæœŸæœ›æ ¼å¼çš„å¯æ‰§è¡Œæ–‡ä»¶: $($latestExe.Name)"
              Rename-Item -Path $latestExe.FullName -NewName $expectedName -Force
            }
          }

          if (Test-Path $expectedPath) {
            $size = (Get-Item $expectedPath).Length / 1MB
            Write-Host "âœ… Windows å¯æ‰§è¡Œæ–‡ä»¶æ„å»ºæˆåŠŸ: $expectedPath"
            Write-Host "ğŸ“Š æ–‡ä»¶å¤§å°: $([math]::Round($size, 2)) MB"

            $fileInfo = Get-Item $expectedPath
            Write-Host "ğŸ“‹ æ–‡ä»¶ä¿¡æ¯:"
            Write-Host "  - åˆ›å»ºæ—¶é—´: $($fileInfo.CreationTime)"
            Write-Host "  - ä¿®æ”¹æ—¶é—´: $($fileInfo.LastWriteTime)"
            Write-Host "  - æ–‡ä»¶å±æ€§: $($fileInfo.Attributes)"
            $envLine = "WINDOWS_EXE_PATH=$expectedPath"
            $envLine | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            Write-Host "âŒ æœªæ‰¾åˆ°é¢„æœŸçš„å¯æ‰§è¡Œæ–‡ä»¶: $expectedPath"
            Write-Host "ğŸ“ dist-onefile ç›®å½•å†…å®¹:"
            Get-ChildItem -Path "dist-onefile" -Recurse | ForEach-Object {
              if ($_.PSIsContainer) {
                Write-Host "  [ç›®å½•] $($_.FullName)"
              } else {
                Write-Host "  $($_.FullName) ($([math]::Round($_.Length/1MB, 2)) MB)"
              }
            }
            exit 1
          }

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            dist-onefile/*.exe
          retention-days: 7

  create-release:
    name: ğŸš€ åˆ›å»º GitHub å‘å¸ƒ
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            INPUT_VERSION="${{ github.event.inputs.version }}"
            if [ -n "$INPUT_VERSION" ]; then
              VERSION="$INPUT_VERSION"
            elif command -v python3 >/dev/null 2>&1; then
              PY_VERSION_SCRIPT=$'import tomllib\n'\
                $'from pathlib import Path\n\n'\
                $'pyproject = Path("pyproject.toml")\n'\
                $'data = tomllib.loads(pyproject.read_text(encoding="utf-8"))\n'\
                $'version = data.get("project", {}).get("version")\n'\
                $'if not version:\n'\
                $'    raise SystemExit("Missing project.version")\n'\
                $'print(version)'
              VERSION=$(python3 -c "$PY_VERSION_SCRIPT")
              echo "â„¹ï¸ æœªæä¾›ç‰ˆæœ¬å·ï¼Œå›é€€åˆ° pyproject.toml ä¸­çš„ $VERSION"
            else
              echo "âŒ æ— æ³•è§£æ pyproject.tomlï¼Œè¯·åœ¨ workflow_dispatch ä¸­æä¾›ç‰ˆæœ¬å·"
              exit 1
            fi
            TAG_NAME="v$VERSION"
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            TAG_NAME=${GITHUB_REF#refs/tags/}
            if [[ "${TAG_NAME}" == *"-"* ]]; then
              RELEASE_TYPE="prerelease"
            else
              RELEASE_TYPE="release"
            fi
          fi

          if [ "$RELEASE_TYPE" = "release" ]; then
            RELEASE_LABEL="æ­£å¼å‘å¸ƒç‰ˆ"
          else
            RELEASE_LABEL="é¢„å‘å¸ƒç‰ˆ"
          fi
          RELEASE_NAME="v${VERSION}"

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "RELEASE_TYPE=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          echo "RELEASE_LABEL=$RELEASE_LABEL" >> $GITHUB_OUTPUT
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“‹ åˆ—å‡ºæ„å»ºäº§ç‰©
        run: |
          echo "ğŸ—‚ï¸ æ„å»ºäº§ç‰©åˆ—è¡¨:"
          find artifacts -type f -name "*.app" -o -name "*.dmg" -o -name "*.exe" | sort

      - name: ğŸ·ï¸ åˆ›å»ºæˆ–æ›´æ–°æ ‡ç­¾
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          LABEL="${{ steps.version.outputs.RELEASE_LABEL }}"
          if [ "$LABEL" = "é¢„å‘å¸ƒç‰ˆ" ]; then
            EMOJI="ğŸš€"
          else
            EMOJI="ğŸ‰"
          fi

          # åˆ é™¤å·²å­˜åœ¨çš„æ ‡ç­¾ï¼ˆå¦‚æœæœ‰ï¼‰
          git tag -d ${{ steps.version.outputs.TAG_NAME }} || true
          git push origin :refs/tags/${{ steps.version.outputs.TAG_NAME }} || true

          # åˆ›å»ºæ–°æ ‡ç­¾
          git tag -a ${{ steps.version.outputs.TAG_NAME }} \
            -m "$EMOJI $LABEL ${{ steps.version.outputs.VERSION }}"
          git push origin ${{ steps.version.outputs.TAG_NAME }}

      - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
        id: release_notes
        run: |
          TAG_NAME="${{ steps.version.outputs.TAG_NAME }}"
          START_COMMIT_INPUT="${{ github.event.inputs.start_commit || '' }}"
          TARGET_COMMIT="${{ github.sha }}"
          START_COMMIT_SOURCE="user-input"

          FEAT_TEMP=$(mktemp)
          FIX_TEMP=$(mktemp)
          trap 'rm -f "$FEAT_TEMP" "$FIX_TEMP"' EXIT

          append_release_entry() {
            local subject="$1"
            local hash="$2"
            if [ -z "$subject" ]; then
              return
            fi
            if echo "$subject" | grep -Eq '^feat\b'; then
              echo "- $subject ($hash)" >> "$FEAT_TEMP"
            elif echo "$subject" | grep -Eq '^fix\b'; then
              echo "- $subject ($hash)" >> "$FIX_TEMP"
            fi
          }

          if [ -z "$START_COMMIT_INPUT" ]; then
            START_COMMIT_SOURCE="previous-tag"
            TAG_PATTERN='v[0-9]*.[0-9]*.[0-9]*'
            PREV_TAG=$(git tag -l "$TAG_PATTERN" --sort=-version:refname \
              | grep -Fvx "$TAG_NAME" | head -n 1)
            if [ -z "$PREV_TAG" ]; then
              echo "âŒ æœªæ‰¾åˆ°ä¸Šä¸€æ­£å¼ç‰ˆæ ‡ç­¾å¯ç”¨ä½œèµ·å§‹æäº¤"
              exit 1
            fi
            START_COMMIT_INPUT=$(git rev-parse "$PREV_TAG^{commit}")
            echo "â„¹ï¸ æœªæä¾›èµ·å§‹æäº¤ï¼Œä½¿ç”¨ä¸Šä¸€æ­£å¼ç‰ˆæ ‡ç­¾ $PREV_TAG ($START_COMMIT_INPUT)"
          else
            echo "â„¹ï¸ ä½¿ç”¨ä¼ å…¥çš„èµ·å§‹æäº¤ï¼š$START_COMMIT_INPUT"
          fi
          if ! git cat-file -e "$START_COMMIT_INPUT^{commit}" 2>/dev/null; then
            echo "âŒ æ— æ³•åœ¨ä»“åº“ä¸­æ‰¾åˆ°èµ·å§‹æäº¤ï¼š$START_COMMIT_INPUT"
            exit 1
          fi

          START_COMMIT=$(git rev-parse "$START_COMMIT_INPUT")

          if ! git merge-base --is-ancestor "$START_COMMIT" "$TARGET_COMMIT"; then
            echo "âŒ èµ·å§‹æäº¤ä¸åœ¨å½“å‰æ„å»ºæäº¤çš„å†å²ä¸­ï¼š$START_COMMIT_INPUT"
            exit 1
          fi

          START_SUBJECT=$(git show -s --format='%s' "$START_COMMIT")
          append_release_entry "$START_SUBJECT" "$START_COMMIT"
          echo "â„¹ï¸ å‘å¸ƒè¯´æ˜èŒƒå›´: $START_COMMIT..$TARGET_COMMIT (èµ·å§‹æ¥æº: $START_COMMIT_SOURCE)"

          git log --format='%H%x09%s' --reverse "$START_COMMIT..$TARGET_COMMIT" |
            while IFS=$'\t' read -r HASH SUBJECT; do
            append_release_entry "$SUBJECT" "$HASH"
          done

          {
            echo "## :sparkles: æ–°åŠŸèƒ½"
            if [ -s "$FEAT_TEMP" ]; then
              cat "$FEAT_TEMP"
            else
              echo "- æš‚æ— æ–°åŠŸèƒ½"
            fi
            echo
            echo "## :bug: ä¿®å¤"
            if [ -s "$FIX_TEMP" ]; then
              cat "$FIX_TEMP"
            else
              echo "- æš‚æ— ä¿®å¤"
            fi
          } > release_notes.md

          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸš€ åˆ›å»º GitHub å‘å¸ƒ
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.version.outputs.TAG_NAME }}
          name: ${{ steps.version.outputs.RELEASE_NAME }}
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          prerelease: ${{ steps.version.outputs.RELEASE_TYPE != 'release' }}
          draft: false
          artifacts: |
            artifacts/windows-artifacts/*.exe
            artifacts/macos-arm64-artifacts/*.dmg
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… å‘å¸ƒå®Œæˆ
        run: |
          RELEASE_LABEL="${{ steps.version.outputs.RELEASE_LABEL }}"
          RELEASE_VERSION="${{ steps.version.outputs.VERSION }}"
          echo "ğŸ‰ $RELEASE_LABEL v$RELEASE_VERSION å‘å¸ƒå®Œæˆ!"
          TAG_NAME="${{ steps.version.outputs.TAG_NAME }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME"
          echo "ğŸ”— å‘å¸ƒé¡µé¢: $RELEASE_URL"
