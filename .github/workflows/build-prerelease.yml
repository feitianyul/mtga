name: ğŸš€ æ„å»ºå’Œå‘å¸ƒé¢„å‘å¸ƒç‰ˆ

on:
  push:
    tags:
      - 'v*.*.*-*'  # é¢„å‘å¸ƒç‰ˆæ ‡ç­¾æ ¼å¼ï¼šv1.2.0-beta.1, v1.2.0-rc.1
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.2.0-beta.1)'
        required: true
        default: '1.2.0-beta.1'

env:
  PYTHON_VERSION: '3.13'

jobs:
  build-macos:
    name: ğŸ æ„å»º macOS
    runs-on: macos-latest
    strategy:
      matrix:
        arch: 
          # - x64
          - arm64
        include:
          # - arch: x64
          #   runner_arch: x86_64
          #   nuitka_arch: x86_64
          - arch: arm64  
            runner_arch: arm64
            nuitka_arch: arm64

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ å®‰è£… uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          uv sync --extra mac-build

      - name: ğŸ› ï¸ å®‰è£… Xcode Command Line Tools
        run: |
          sudo xcode-select --install || true
          # ç­‰å¾…å®‰è£…å®Œæˆæˆ–è·³è¿‡å¦‚æœå·²å®‰è£…
          while ! xcode-select -p &>/dev/null; do
            echo "ç­‰å¾… Xcode Command Line Tools å®‰è£…..."
            sleep 10
          done

      - name: âš™ï¸ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "APP_NAME=MTGA_GUI-v$VERSION-${{ matrix.arch }}" >> $GITHUB_OUTPUT
          echo "DMG_NAME=MTGA_GUI-v$VERSION-${{ matrix.arch }}" >> $GITHUB_OUTPUT

      - name: ğŸ”¨ æ„å»º macOS åº”ç”¨åŒ…
        run: |
          # ä¿®æ”¹æ„å»ºè„šæœ¬ä¸­çš„ç‰ˆæœ¬å·
          sed -i.bak "s/VERSION=\".*\"/VERSION=\"${{ steps.version.outputs.VERSION }}\"/g" build_mac_app.sh
          
          # æ ¹æ®æ¶æ„è®¾ç½®è¾“å‡ºæ–‡ä»¶å
          sed -i.bak "s/--output-filename=MTGA_GUI-v\$VERSION-\$(uname -m)/--output-filename=${{ steps.version.outputs.APP_NAME }}/g" build_mac_app.sh
          
          # æ‰§è¡Œæ„å»º
          chmod +x build_mac_app.sh
          ./build_mac_app.sh

      - name: ğŸ“± éªŒè¯åº”ç”¨åŒ…
        run: |
          APP_PATH="dist-onefile/${{ steps.version.outputs.APP_NAME }}.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ åº”ç”¨åŒ…æ„å»ºå¤±è´¥: $APP_PATH ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… åº”ç”¨åŒ…æ„å»ºæˆåŠŸ: $APP_PATH"
          echo "ğŸ“Š åº”ç”¨åŒ…å¤§å°: $(du -sh "$APP_PATH" | cut -f1)"
          echo "ğŸ“ åº”ç”¨åŒ…ç»“æ„:"
          find "$APP_PATH" -maxdepth 2 -type d | head -10

      - name: ğŸ åˆ›å»º DMG å®‰è£…åŒ…
        run: |
          # ç¡®ä¿ DMG é…ç½®æ–‡ä»¶å­˜åœ¨
          if [ ! -f "mac/dmg_settings.py" ]; then
            echo "âŒ DMG é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: mac/dmg_settings.py"
            exit 1
          fi
          
          # åˆ›å»º DMG
          uv run dmgbuild \
            -s mac/dmg_settings.py \
            "MTGA GUI v${{ steps.version.outputs.VERSION }} Installer" \
            "dist-onefile/${{ steps.version.outputs.DMG_NAME }}.dmg"
          
          echo "âœ… DMG åˆ›å»ºæˆåŠŸ"
          echo "ğŸ“Š DMG å¤§å°: $(du -sh "dist-onefile/${{ steps.version.outputs.DMG_NAME }}.dmg" | cut -f1)"

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-artifacts
          path: |
            dist-onefile/${{ steps.version.outputs.APP_NAME }}.app
            dist-onefile/${{ steps.version.outputs.DMG_NAME }}.dmg
          retention-days: 7

  # Windows æ„å»ºä»»åŠ¡ï¼ˆé¢„ç•™æ¡†æ¶ï¼‰
  build-windows:
    name: ğŸªŸ æ„å»º Windows
    runs-on: windows-latest
    if: false  # æš‚æ—¶ç¦ç”¨ï¼Œåç»­å¯ç”¨
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      # TODO: å®ç° Windows æ„å»ºé€»è¾‘
      - name: ğŸ”§ Windows æ„å»º (å ä½ç¬¦)
        run: echo "Windows æ„å»ºå°†åœ¨åç»­å®ç°"

  create-prerelease:
    name: ğŸš€ åˆ›å»ºé¢„å‘å¸ƒç‰ˆ
    needs: [build-macos]  # build-windows å‡†å¤‡å¥½æ—¶åŠ å…¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: âš™ï¸ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG_NAME="v$VERSION"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            TAG_NAME=${GITHUB_REF#refs/tags/}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“‹ åˆ—å‡ºæ„å»ºäº§ç‰©
        run: |
          echo "ğŸ—‚ï¸ æ„å»ºäº§ç‰©åˆ—è¡¨:"
          find artifacts -type f -name "*.app" -o -name "*.dmg" -o -name "*.exe" | sort

      - name: ğŸ·ï¸ åˆ›å»ºæˆ–æ›´æ–°æ ‡ç­¾
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # åˆ é™¤å·²å­˜åœ¨çš„æ ‡ç­¾ï¼ˆå¦‚æœæœ‰ï¼‰
          git tag -d ${{ steps.version.outputs.TAG_NAME }} || true
          git push origin :refs/tags/${{ steps.version.outputs.TAG_NAME }} || true
          
          # åˆ›å»ºæ–°æ ‡ç­¾
          git tag -a ${{ steps.version.outputs.TAG_NAME }} -m "ğŸš€ é¢„å‘å¸ƒç‰ˆ ${{ steps.version.outputs.VERSION }}"
          git push origin ${{ steps.version.outputs.TAG_NAME }}

      - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ğŸš€ MTGA GUI v${{ steps.version.outputs.VERSION }} (é¢„å‘å¸ƒç‰ˆ)
          
          > âš ï¸ **è¿™æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„åŠŸèƒ½ï¼Œè¯·è°¨æ…åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚**
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          #### macOS ç”¨æˆ·
          - **Intel Mac**: ä¸‹è½½ `MTGA_GUI-v${{ steps.version.outputs.VERSION }}-x64.dmg`
          - **Apple Silicon Mac**: ä¸‹è½½ `MTGA_GUI-v${{ steps.version.outputs.VERSION }}-arm64.dmg`
          
          #### å®‰è£…æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ DMG æ–‡ä»¶
          2. åŒå‡» DMG æ–‡ä»¶æŒ‚è½½å®‰è£…åŒ…
          3. å°† `MTGA GUI.app` æ‹–æ‹½åˆ° `Applications` æ–‡ä»¶å¤¹
          4. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸è¿è¡Œ
          
          ### ğŸ”§ æŠ€æœ¯ä¿¡æ¯
          - Python ç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}
          - æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          
          ### ğŸ› é—®é¢˜åé¦ˆ
          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [GitHub Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆã€‚
          EOF
          
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸš€ åˆ›å»º GitHub é¢„å‘å¸ƒç‰ˆ
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.version.outputs.TAG_NAME }}
          name: "ğŸš€ MTGA GUI v${{ steps.version.outputs.VERSION }}"
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          prerelease: true
          draft: false
          artifacts: |
            artifacts/macos-x64-artifacts/*.dmg
            artifacts/macos-arm64-artifacts/*.dmg
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… å‘å¸ƒå®Œæˆ
        run: |
          echo "ğŸ‰ é¢„å‘å¸ƒç‰ˆ v${{ steps.version.outputs.VERSION }} å‘å¸ƒå®Œæˆ!"
          echo "ğŸ”— å‘å¸ƒé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.TAG_NAME }}"