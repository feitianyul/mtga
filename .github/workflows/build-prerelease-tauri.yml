name: ğŸš€ æ„å»ºå’Œå‘å¸ƒç‰ˆæœ¬(TAURI)
on:
  push:
    tags:
      - "v2.*.*-*" # é¢„å‘å¸ƒç‰ˆæ ‡ç­¾æ ¼å¼ï¼šv2.0.0-beta.1, v2.0.0-rc.1
      - "v2.*.*" # æ­£å¼ç‰ˆæ ‡ç­¾ï¼šv2.0.0
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (ä¾‹å¦‚: 2.0.0-beta.1)"
        required: false
        default: "2.0.0-beta.1"
      release_type:
        description: "å‘å¸ƒç±»å‹"
        required: true
        default: "prerelease"
        type: choice
        options:
          - prerelease
          - release
      start_commit:
        description: >-
          èµ·å§‹æäº¤å“ˆå¸Œï¼ˆç¤ºä¾‹ï¼š
          1234567890abcdef1234567890abcdef12345678ï¼‰
        required: false
        default: ""

env:
  PYTHON_VERSION: "3.13"

jobs:
  prepare-version:
    name: ğŸ§® è®¡ç®—ç‰ˆæœ¬ä¿¡æ¯
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
      release_type: ${{ steps.version.outputs.release_type }}
      release_label: ${{ steps.version.outputs.release_label }}
      release_name: ${{ steps.version.outputs.release_name }}

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ è®¾ç½® Python
        id: setup-python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: âš™ï¸ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.version }}" ]; then
              VERSION="${{ github.event.inputs.version }}"
            elif command -v python3 >/dev/null 2>&1; then
              PY_VERSION_SCRIPT=$'import json\n'\
                $'from pathlib import Path\n\n'\
                $'tauri_conf = Path("mtga-tauri/src-tauri/tauri.conf.json")\n'\
                $'data = json.loads(tauri_conf.read_text(encoding="utf-8"))\n'\
                $'version = data.get("version")\n'\
                $'if not version:\n'\
                $'    raise SystemExit("Missing version in tauri.conf.json")\n'\
                $'print(version)'
              VERSION=$(python3 -c "$PY_VERSION_SCRIPT")
              echo "â„¹ï¸ æœªæä¾›ç‰ˆæœ¬å·ï¼Œå›é€€åˆ° mtga-tauri/src-tauri/tauri.conf.json ä¸­çš„ $VERSION"
            else
              echo "âŒ æ— æ³•è§£æ mtga-tauri/src-tauri/tauri.conf.jsonï¼Œè¯·åœ¨ workflow_dispatch ä¸­æä¾›ç‰ˆæœ¬å·"
              exit 1
            fi
            TAG_NAME="v$VERSION"
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            TAG_NAME=${GITHUB_REF#refs/tags/}
            if [[ "${TAG_NAME}" == *"-"* ]]; then
              RELEASE_TYPE="prerelease"
            else
              RELEASE_TYPE="release"
            fi
          fi

          if [ "$RELEASE_TYPE" = "release" ]; then
            RELEASE_LABEL="æ­£å¼å‘å¸ƒç‰ˆ"
          else
            RELEASE_LABEL="é¢„å‘å¸ƒç‰ˆ"
          fi
          RELEASE_NAME="v${VERSION}"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          echo "release_label=$RELEASE_LABEL" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT

  build-macos:
    name: ğŸ æ„å»º macOS
    needs: prepare-version
    runs-on: macos-latest
    env:
      UV_CACHE_DIR: ${{ github.workspace }}/.uv_cache
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TAURI_BUNDLER_DEBUG: "true"
      RUST_LOG: tauri_bundler=debug
    strategy:
      matrix:
        arch:
          # - x64
          - arm64
        include:
          # - arch: x64
          #   runner_arch: x86_64
          #   nuitka_arch: x86_64
          - arch: arm64
            runner_arch: arm64
            nuitka_arch: arm64

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ è®¾ç½® Python
        id: setup-python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸŸ¢ è®¾ç½® Node
        uses: actions/setup-node@v6
        with:
          node-version-file: mtga-tauri/package.json

      - name: ğŸ”§ å¯ç”¨ Corepack
        id: pnpm-store
        env:
          COREPACK_ENABLE_DOWNLOAD_PROMPT: "0"
        run: |
          corepack enable
          pnpm --version
          echo "pnpm_store_path=$(pnpm store path --silent)" >> "$GITHUB_OUTPUT"

      - name: ğŸ’¾ ç¼“å­˜ pnpm store
        uses: actions/cache@v5
        with:
          path: ${{ steps.pnpm-store.outputs.pnpm_store_path }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('mtga-tauri/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: ğŸ¦€ è®¾ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ§° ç¼“å­˜ Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            mtga-tauri/src-tauri
          shared-key: tauri-${{ runner.os }}-${{ matrix.arch }}

      - name: ğŸ” è°ƒè¯• uv.lock
        run: |
          pwd
          ls -l mtga-tauri/python-src/uv.lock || echo "mtga-tauri/python-src/uv.lock ä¸å­˜åœ¨"
          head -5 mtga-tauri/python-src/uv.lock || true

      - name: ğŸ§® è®¡ç®— uv.lock å“ˆå¸Œ
        id: uv-lock-hash
        run: |
          if [ -f mtga-tauri/python-src/uv.lock ]; then
            echo "hash=$(shasum -a 256 mtga-tauri/python-src/uv.lock | cut -d ' ' -f1)" >> "$GITHUB_OUTPUT"
          else
            echo "hash=missing" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ uv.lock ä¸å­˜åœ¨ï¼Œç¼“å­˜ key ä½¿ç”¨ missing"
          fi

      - name: ğŸ’¾ ç¼“å­˜ uv ä¾èµ–
        uses: actions/cache@v5
        with:
          path: |
            mtga-tauri/python-src/.venv
            .uv_cache
            ~/.local/bin/uv
            ~/.local/bin/uvx
          key: ${{ runner.os }}-py-${{ steps.setup-python.outputs.python-version }}-uv-${{ matrix.arch }}-${{ steps.uv-lock-hash.outputs.hash }}
          restore-keys: |
            ${{ runner.os }}-py-${{ steps.setup-python.outputs.python-version }}-uv-${{ matrix.arch }}-

      - name: ğŸ“¦ å®‰è£… uv
        run: |
          set -euo pipefail
          export PATH="$HOME/.local/bin:$PATH"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

          # å®‰è£…è„šæœ¬å†…éƒ¨ä¼šä» GitHub ä¸‹è½½ release èµ„æºï¼Œç½‘ç»œæŠ–åŠ¨æ—¶å¯èƒ½æ‰“å° curl é”™è¯¯ä½†æœ€ç»ˆé€€å‡º 0ï¼Œ
          # å› æ­¤è¿™é‡Œä»¥ "uv æ˜¯å¦å¯ç”¨" ä½œä¸ºæˆåŠŸåˆ¤å®šå¹¶é‡è¯•ï¼Œé¿å…åç»­å‡ºç° uv: command not foundã€‚
          for i in 1 2 3; do
            if command -v uv >/dev/null 2>&1; then
              break
            fi
            echo "ğŸ” å°è¯•å®‰è£… uvï¼ˆç¬¬ $i æ¬¡ï¼‰..."
            curl -LsSf https://astral.sh/uv/install.sh | sh || true
            sleep $((i * 5))
          done

          if ! command -v uv >/dev/null 2>&1; then
            echo "âŒ uv å®‰è£…å¤±è´¥ï¼ˆå¤šæ¬¡é‡è¯•åä»ä¸å¯ç”¨ï¼‰"
            exit 1
          fi

          uv --version

      - name: ğŸ”§ åŒæ­¥ Python ä¾èµ–
        run: uv sync --project .
        working-directory: mtga-tauri/python-src

      - name: ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
        run: pnpm install --frozen-lockfile
        working-directory: mtga-tauri

      - name: ğŸ“¥ å‡†å¤‡ pyembed Python
        run: |
          set -euo pipefail
          PYEMBED_DIR="mtga-tauri/src-tauri/pyembed"
          mkdir -p "$PYEMBED_DIR"
          ASSET_URL=$(gh api /repos/astral-sh/python-build-standalone/releases/latest \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            --jq '.assets[] | select(.name | test("cpython-3\\.13\\..*\\+.*-aarch64-apple-darwin-install_only_stripped\\.tar\\.gz")) | .browser_download_url' \
            | head -n 1)
          if [ -z "$ASSET_URL" ]; then
            echo "âŒ æœªæ‰¾åˆ°åŒ¹é…çš„ Python æ„å»ºäº§ç‰©"
            exit 1
          fi
          echo "â¬‡ï¸ ä¸‹è½½: $ASSET_URL"
          curl -L "$ASSET_URL" -o /tmp/python-standalone.tar.gz
          tar -xzf /tmp/python-standalone.tar.gz -C "$PYEMBED_DIR"

      - name: ğŸ§¾ å†™å…¥ pyembed .env
        run: |
          set -euo pipefail
          ENV_DIR="mtga-tauri/src-tauri/pyembed/python/lib/python3.13"
          mkdir -p "$ENV_DIR"
          cp mtga-tauri/.env.example "$ENV_DIR/.env"

      - name: ğŸ› ï¸ å®‰è£… Xcode Command Line Tools
        run: |
          sudo xcode-select --install || true
          # ç­‰å¾…å®‰è£…å®Œæˆæˆ–è·³è¿‡å¦‚æœå·²å®‰è£…
          while ! xcode-select -p &>/dev/null; do
            echo "ç­‰å¾… Xcode Command Line Tools å®‰è£…..."
            sleep 10
          done

      - name: ğŸ§° è®¾ç½® Xcode å·¥å…·è·¯å¾„
        run: |
          set -euo pipefail
          DEV_DIR=$(xcode-select -p)
          echo "DEV_DIR=$DEV_DIR"
          echo "$DEV_DIR/usr/bin" >> "$GITHUB_PATH"
          which SetFile || true

      - name: ğŸ§¾ å†™å…¥å†…åµŒç‰ˆæœ¬å·
        run: |
          set -euo pipefail
          APP_VERSION="${{ needs.prepare-version.outputs.version }}"
          if [ -z "$APP_VERSION" ]; then
            echo "âŒ version ä¸ºç©º"
            exit 1
          fi
          if [[ "$APP_VERSION" != v* ]]; then
            APP_VERSION="v$APP_VERSION"
          fi
          printf 'BUILT_APP_VERSION = "%s"\n' "$APP_VERSION" > mtga-tauri/python-src/modules/runtime/_build_version.py
          echo "å·²å†™å…¥ç‰ˆæœ¬å·åˆ° mtga-tauri/python-src/modules/runtime/_build_version.py: $APP_VERSION"

      - name: ğŸ§© å®‰è£… pytauri ä¾èµ–
        run: pnpm pytauri:install:mac
        working-directory: mtga-tauri

      - name: ğŸ§± æ‰“åŒ… Tauri
        run: pnpm tauri:bundle:mac:ci
        working-directory: mtga-tauri

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v6
        with:
          name: macos-${{ matrix.arch }}-artifacts
          path: |
            mtga-tauri/src-tauri/target/bundle-release/bundle/dmg/*.dmg
          retention-days: 7

  build-windows:
    name: ğŸªŸ æ„å»º Windows
    needs: prepare-version
    runs-on: windows-latest
    env:
      UV_CACHE_DIR: "${{ github.workspace }}\\.uv_cache"
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: ğŸ è®¾ç½® Python
        id: setup-python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸŸ¢ è®¾ç½® Node
        uses: actions/setup-node@v6
        with:
          node-version-file: mtga-tauri/package.json

      - name: ğŸ”§ å¯ç”¨ Corepack
        id: pnpm-store
        env:
          COREPACK_ENABLE_DOWNLOAD_PROMPT: "0"
        run: |
          corepack enable
          pnpm --version
          $store = pnpm store path --silent
          "pnpm_store_path=$store" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: ğŸ’¾ ç¼“å­˜ pnpm store
        uses: actions/cache@v5
        with:
          path: ${{ steps.pnpm-store.outputs.pnpm_store_path }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('mtga-tauri/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: ğŸ¦€ è®¾ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ§° ç¼“å­˜ Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            mtga-tauri/src-tauri
          shared-key: tauri-${{ runner.os }}-x64

      - name: ğŸ” è°ƒè¯• uv.lock
        run: |
          Get-Location
          if (Test-Path mtga-tauri/python-src/uv.lock) {
            Get-Item mtga-tauri/python-src/uv.lock | Format-List FullName,Length
            Get-Content mtga-tauri/python-src/uv.lock -TotalCount 5
          } else {
            Write-Host "mtga-tauri/python-src/uv.lock ä¸å­˜åœ¨"
          }

      - name: ğŸ§® è®¡ç®— uv.lock å“ˆå¸Œ
        id: uv-lock-hash
        run: |
          if (Test-Path mtga-tauri/python-src/uv.lock) {
            $hash = (Get-FileHash mtga-tauri/python-src/uv.lock -Algorithm SHA256).Hash
          } else {
            $hash = "missing"
            Write-Host "âš ï¸ uv.lock ä¸å­˜åœ¨ï¼Œç¼“å­˜ key ä½¿ç”¨ missing"
          }
          "hash=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: ğŸ’¾ ç¼“å­˜ uv ä¾èµ–
        uses: actions/cache@v5
        with:
          path: |
            mtga-tauri/python-src/.venv
            .uv_cache
            ${{ env.USERPROFILE }}\.local\bin\uv.exe
            ${{ env.USERPROFILE }}\.local\bin\uvx.exe
          key: ${{ runner.os }}-py-${{ steps.setup-python.outputs.python-version }}-uv-win-${{ steps.uv-lock-hash.outputs.hash }}
          restore-keys: |
            ${{ runner.os }}-py-${{ steps.setup-python.outputs.python-version }}-uv-win-

      - name: ğŸ“¦ å®‰è£… uv
        run: |
          $ErrorActionPreference = "Stop"
          $uvBinDir = Join-Path $env:USERPROFILE ".local\\bin"
          $env:PATH = "$uvBinDir;$env:PATH"
          $uvBinDir | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          for ($i = 1; $i -le 3; $i++) {
            if (Get-Command uv -ErrorAction SilentlyContinue) {
              break
            }
            Write-Host "ğŸ” å°è¯•å®‰è£… uvï¼ˆç¬¬ $i æ¬¡ï¼‰..."
            try {
              Invoke-WebRequest -Uri "https://astral.sh/uv/install.ps1" -OutFile "install.ps1"
              ./install.ps1
            } catch {
              Write-Host "âš ï¸ uv å®‰è£…è„šæœ¬æ‰§è¡Œå¤±è´¥: $($_.Exception.Message)"
            }
            Start-Sleep -Seconds (5 * $i)
          }

          if (-not (Get-Command uv -ErrorAction SilentlyContinue)) {
            throw "uv å®‰è£…å¤±è´¥ï¼ˆå¤šæ¬¡é‡è¯•åä»ä¸å¯ç”¨ï¼‰"
          }

          uv --version

      - name: ğŸ”§ åŒæ­¥ Python ä¾èµ–
        run: uv sync --project .
        working-directory: mtga-tauri/python-src

      - name: ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
        run: pnpm install --frozen-lockfile
        working-directory: mtga-tauri

      - name: ğŸ“¥ å‡†å¤‡ pyembed Python
        run: |
          $ErrorActionPreference = "Stop"
          $pyembedDir = "mtga-tauri/src-tauri/pyembed"
          New-Item -ItemType Directory -Path $pyembedDir -Force | Out-Null
          $assetUrl = gh api /repos/astral-sh/python-build-standalone/releases/latest `
            -H "Accept: application/vnd.github+json" `
            -H "X-GitHub-Api-Version: 2022-11-28" `
            --jq '.assets[] | select(.name | test("cpython-3\\.13\\..*\\+.*-x86_64-pc-windows-msvc-install_only_stripped\\.tar\\.gz")) | .browser_download_url' |
            Select-Object -First 1
          if (-not $assetUrl) { throw "âŒ æœªæ‰¾åˆ°åŒ¹é…çš„ Python æ„å»ºäº§ç‰©" }
          $archivePath = Join-Path $pyembedDir "python-standalone.tar.gz"
          Write-Host "â¬‡ï¸ ä¸‹è½½: $assetUrl"
          Invoke-WebRequest -Uri $assetUrl -OutFile $archivePath
          tar -xzf $archivePath -C $pyembedDir

      - name: ğŸ§¾ å†™å…¥ pyembed .env
        run: |
          $envDir = "mtga-tauri/src-tauri/pyembed/python/Lib"
          New-Item -ItemType Directory -Path $envDir -Force | Out-Null
          Copy-Item -Path "mtga-tauri/.env.example" -Destination (Join-Path $envDir ".env") -Force

      - name: ğŸ§¾ å†™å…¥å†…åµŒç‰ˆæœ¬å·
        run: |
          $version = "${{ needs.prepare-version.outputs.version }}"
          if (-not $version) { throw "âŒ version ä¸ºç©º" }
          if ($version[0] -ne 'v') { $version = "v$version" }
          $line = "BUILT_APP_VERSION = `"$version`""
          Set-Content -Path "mtga-tauri/python-src/modules/runtime/_build_version.py" -Value $line -Encoding utf8
          Write-Host "å·²å†™å…¥ç‰ˆæœ¬å·åˆ° mtga-tauri/python-src/modules/runtime/_build_version.py: $version"

      - name: ğŸ§© å®‰è£… pytauri ä¾èµ–
        run: pnpm pytauri:install:win
        working-directory: mtga-tauri

      - name: ğŸ§± æ‰“åŒ… Tauri
        run: pnpm tauri:bundle:win:ci
        working-directory: mtga-tauri

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v6
        with:
          name: windows-artifacts
          path: |
            mtga-tauri/src-tauri/target/bundle-release/bundle/nsis/*.exe
          retention-days: 7

  create-release:
    name: ğŸš€ åˆ›å»º GitHub å‘å¸ƒ
    needs: [prepare-version, build-windows, build-macos]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: ğŸ“‹ åˆ—å‡ºæ„å»ºäº§ç‰©
        run: |
          echo "ğŸ—‚ï¸ æ„å»ºäº§ç‰©åˆ—è¡¨:"
          find artifacts -type f \( -name "*.app" -o -name "*.dmg" -o -name "*.exe" \) | sort

      - name: ğŸ§­ è®¾ç½®å‘å¸ƒç¯å¢ƒå˜é‡
        run: |
          echo "VERSION=${{ needs.prepare-version.outputs.version }}" >> $GITHUB_ENV
          echo "TAG_NAME=${{ needs.prepare-version.outputs.tag_name }}" >> $GITHUB_ENV
          echo "RELEASE_TYPE=${{ needs.prepare-version.outputs.release_type }}" >> $GITHUB_ENV
          echo "RELEASE_LABEL=${{ needs.prepare-version.outputs.release_label }}" >> $GITHUB_ENV
          echo "RELEASE_NAME=${{ needs.prepare-version.outputs.release_name }}" >> $GITHUB_ENV

      - name: ğŸ·ï¸ åˆ›å»ºæˆ–æ›´æ–°æ ‡ç­¾
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          LABEL="$RELEASE_LABEL"
          if [ "$LABEL" = "é¢„å‘å¸ƒç‰ˆ" ]; then
            EMOJI="ğŸš€"
          else
            EMOJI="ğŸ‰"
          fi

          # åˆ é™¤å·²å­˜åœ¨çš„æ ‡ç­¾ï¼ˆå¦‚æœæœ‰ï¼‰
          git tag -d "$TAG_NAME" || true
          git push origin :refs/tags/"$TAG_NAME" || true

          # åˆ›å»ºæ–°æ ‡ç­¾
          git tag -a "$TAG_NAME" \
            -m "$EMOJI $LABEL $VERSION"
          git push origin "$TAG_NAME"

      - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
        id: release_notes
        run: |
          TAG_NAME="$TAG_NAME"
          START_COMMIT_INPUT="${{ github.event.inputs.start_commit || '' }}"
          TARGET_COMMIT="${{ github.sha }}"
          START_COMMIT_SOURCE="user-input"

          FEAT_TEMP=$(mktemp)
          FIX_TEMP=$(mktemp)
          STYLE_TEMP=$(mktemp)
          trap 'rm -f "$FEAT_TEMP" "$FIX_TEMP" "$STYLE_TEMP"' EXIT

          append_release_entry() {
            local subject="$1"
            local hash="$2"
            if [ -z "$subject" ]; then
              return
            fi
            if echo "$subject" | grep -Eq '^feat\b'; then
              echo "- $subject ($hash)" >> "$FEAT_TEMP"
            elif echo "$subject" | grep -Eq '^fix\b'; then
              echo "- $subject ($hash)" >> "$FIX_TEMP"
            elif echo "$subject" | grep -Eq '^style\b'; then
              echo "- $subject ($hash)" >> "$STYLE_TEMP"
            fi
          }

          if [ -z "$START_COMMIT_INPUT" ]; then
            START_COMMIT_SOURCE="previous-tag"
            TAG_PATTERN='v*'
            PREV_TAG=$(git tag -l "$TAG_PATTERN" --sort=-version:refname \
              | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
              | grep -Fvx "$TAG_NAME" | head -n 1)
            if [ -z "$PREV_TAG" ]; then
              echo "âŒ æœªæ‰¾åˆ°ä¸Šä¸€æ­£å¼ç‰ˆæ ‡ç­¾å¯ç”¨ä½œèµ·å§‹æäº¤"
              exit 1
            fi
            START_COMMIT_INPUT=$(git rev-parse "$PREV_TAG^{commit}")
            echo "â„¹ï¸ æœªæä¾›èµ·å§‹æäº¤ï¼Œä½¿ç”¨ä¸Šä¸€æ­£å¼ç‰ˆæ ‡ç­¾ $PREV_TAG ($START_COMMIT_INPUT)"
          else
            echo "â„¹ï¸ ä½¿ç”¨ä¼ å…¥çš„èµ·å§‹æäº¤ï¼š$START_COMMIT_INPUT"
          fi
          if ! git cat-file -e "$START_COMMIT_INPUT^{commit}" 2>/dev/null; then
            echo "âŒ æ— æ³•åœ¨ä»“åº“ä¸­æ‰¾åˆ°èµ·å§‹æäº¤ï¼š$START_COMMIT_INPUT"
            exit 1
          fi

          START_COMMIT=$(git rev-parse "$START_COMMIT_INPUT")

          if ! git merge-base --is-ancestor "$START_COMMIT" "$TARGET_COMMIT"; then
            echo "âŒ èµ·å§‹æäº¤ä¸åœ¨å½“å‰æ„å»ºæäº¤çš„å†å²ä¸­ï¼š$START_COMMIT_INPUT"
            exit 1
          fi

          START_SUBJECT=$(git show -s --format='%s' "$START_COMMIT")
          append_release_entry "$START_SUBJECT" "$START_COMMIT"
          echo "â„¹ï¸ å‘å¸ƒè¯´æ˜èŒƒå›´: $START_COMMIT..$TARGET_COMMIT (èµ·å§‹æ¥æº: $START_COMMIT_SOURCE)"

          git log --format='%H%x09%s' --reverse "$START_COMMIT..$TARGET_COMMIT" |
            while IFS=$'\t' read -r HASH SUBJECT; do
            append_release_entry "$SUBJECT" "$HASH"
          done

          {
            echo "## :sparkles: æ–°åŠŸèƒ½"
            if [ -s "$FEAT_TEMP" ]; then
              cat "$FEAT_TEMP"
            else
              echo "- æš‚æ— æ–°åŠŸèƒ½"
            fi
            echo
            echo "## :bug: ä¿®å¤"
            if [ -s "$FIX_TEMP" ]; then
              cat "$FIX_TEMP"
            else
              echo "- æš‚æ— ä¿®å¤"
            fi
            echo
            echo "## :art: ç•Œé¢æ ·å¼"
            if [ -s "$STYLE_TEMP" ]; then
              cat "$STYLE_TEMP"
            else
              echo "- æš‚æ— ç•Œé¢æ ·å¼"
            fi
          } > release_notes.md

          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸš€ åˆ›å»º GitHub å‘å¸ƒ
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.prepare-version.outputs.tag_name }}
          name: ${{ needs.prepare-version.outputs.release_name }}
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          prerelease: ${{ needs.prepare-version.outputs.release_type != 'release' }}
          draft: false
          artifacts: |
            artifacts/windows-artifacts/*.exe
            artifacts/macos-arm64-artifacts/*.dmg
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… å‘å¸ƒå®Œæˆ
        run: |
          RELEASE_LABEL="$RELEASE_LABEL"
          RELEASE_VERSION="$VERSION"
          echo "ğŸ‰ $RELEASE_LABEL v$RELEASE_VERSION å‘å¸ƒå®Œæˆ!"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME"
          echo "ğŸ”— å‘å¸ƒé¡µé¢: $RELEASE_URL"
