name: âš™ï¸ Nuitka åŸå‹éªŒè¯

on:
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.13"
  PROBE_ENTRY: tests/nuitka_probe_app.py
  PROBE_OUTPUT_DIR: dist-onefile

jobs:
  nuitka-probe:
    name: ğŸ§ª Windows Nuitka åŸå‹
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“‚ æ‰“å°å·¥ä½œç›®å½•ä¿¡æ¯
        run: |
          $workspace = Resolve-Path .
          Write-Host "GITHUB_WORKSPACE: $env:GITHUB_WORKSPACE"
          Write-Host "å½“å‰å·¥ä½œç›®å½•: $($workspace.Path)"
          Write-Host "ç›®å½•å†…å®¹:"
          Get-ChildItem | ForEach-Object { Write-Host "  $($_.FullName)" }

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ å®‰è£… uv
        run: |
          Invoke-WebRequest -Uri "https://astral.sh/uv/install.ps1" -OutFile "install.ps1"
          ./install.ps1
          echo "$env:USERPROFILE\.local\bin" |
            Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: ğŸ”§ å®‰è£…ä¾èµ– (win-build)
        run: |
          uv sync --extra win-build

      - name: ğŸ” æ£€æŸ¥ Visual Studio
        run: |
          $vcBuildDir = $null
          $vswhereBase = ${env:ProgramFiles(x86)}
          $vsInstallerPath = "Microsoft Visual Studio\Installer\vswhere.exe"
          $vswherePath = Join-Path $vswhereBase $vsInstallerPath
          if (Test-Path $vswherePath) {
            try {
              $vswhereArgs = @(
                '-latest'
                '-products' '*'
                '-requires'
                'Microsoft.VisualStudio.Component.VC.Tools.x86.x64'
                '-property' 'installationPath'
              )
              $installationPath = & $vswherePath @vswhereArgs
              if ($installationPath) {
                $candidate = Join-Path $installationPath "VC\Auxiliary\Build"
                if (Test-Path $candidate) {
                  $vcBuildDir = $candidate
                }
              }
            } catch {
              Write-Host "âš ï¸ vswhere æ£€æµ‹å¤±è´¥: $_"
            }
          }

          if (-not $vcBuildDir) {
            $fallbackPaths = @(
              "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build",
              "C:\Program Files\Microsoft Visual Studio\2022\Professional\VC\Auxiliary\Build",
              "C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build",
              "C:\Program Files\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build",
              "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build",
              "C:\Program Files (x86)\Microsoft Visual Studio\2019\Professional\VC\Auxiliary\Build",
              "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build",
              "C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Auxiliary\Build"
            )

            foreach ($path in $fallbackPaths) {
              if (Test-Path $path) {
                $vcBuildDir = $path
                break
              }
            }
          }

          if ($vcBuildDir) {
            Write-Host "âœ… æ‰¾åˆ°å¯ç”¨çš„ MSVC ç¯å¢ƒ: $vcBuildDir"
            "VC_BUILD_DIR=$vcBuildDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            Write-Host "âŒ æœªæ‰¾åˆ°ä»»ä½•å·²å®‰è£…çš„ Visual Studio MSVC ç¯å¢ƒï¼Œåç»­æ„å»ºå¯èƒ½å¤±è´¥"
          }

      - name: âš™ï¸ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          $probeVersion = "probe-${{ github.run_id }}"
          echo "VERSION=$probeVersion" >> $env:GITHUB_OUTPUT
          $exeName = "MTGA_GUI-v$probeVersion-x64.exe"
          echo "EXE_NAME=$exeName" >> $env:GITHUB_OUTPUT

      - name: ğŸ”¨ æ„å»º Nuitka åŸå‹ (å¿«é€Ÿ)
        run: |
          $entryPath = (Resolve-Path $env:PROBE_ENTRY).Path
          $version = "${{ steps.version.outputs.VERSION }}"
          if ($env:VC_BUILD_DIR) {
            Write-Host "ä¼ å…¥ MSVC ç›®å½•: $env:VC_BUILD_DIR"
            & .\build_probe_onefile.bat "$env:VC_BUILD_DIR" "$version" "$entryPath"
          } else {
            & .\build_probe_onefile.bat "" "$version" "$entryPath"
          }

      - name: ğŸ” éªŒè¯æ„å»ºäº§ç‰©ï¼ˆå«ç»å¯¹è·¯å¾„ï¼‰
        run: |
          $workspace = Resolve-Path .
          $distDir = Join-Path $workspace.Path $env:PROBE_OUTPUT_DIR
          $exePath = $env:PROBE_EXE_PATH
          $expectedName = "${{ steps.version.outputs.EXE_NAME }}"
          Write-Host "å·¥ä½œç›®å½•ç»å¯¹è·¯å¾„: $($workspace.Path)"
          Write-Host "dist-onefile ç»å¯¹è·¯å¾„: $distDir"
          if (-not $exePath) {
            $exePath = Join-Path $distDir $expectedName
          }
          Write-Host "æœŸæœ›çš„äº§ç‰©è·¯å¾„: $exePath"

          if (Test-Path $exePath) {
            $exeItem = Get-Item $exePath
            Write-Host "âœ… æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: $($exeItem.FullName)"
            Write-Host "æ–‡ä»¶å¤§å°: $([math]::Round($exeItem.Length / 1MB, 2)) MB"
            Write-Host "dist-onefile é¡¶å±‚å†…å®¹:"
            Get-ChildItem -Path $distDir | ForEach-Object { Write-Host "  $($_.FullName)" }
            $exeFullPath = $exeItem.FullName
            $envLine = "PROBE_EXE_PATH=$exeFullPath"
            $envLine | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            Write-Host "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: $exePath"
            Write-Host "å½“å‰ dist-onefile å†…å®¹:"
            Get-ChildItem -Path $distDir -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  $($_.FullName)"
            }
            exit 1
          }

      - name: â–¶ï¸ è¿è¡ŒåŸå‹å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          $exePath = $env:PROBE_EXE_PATH
          if (-not $exePath) {
            $workspace = Resolve-Path .
            $exePath = Join-Path $workspace.Path $env:PROBE_OUTPUT_DIR
            $exePath = Join-Path $exePath "${{ steps.version.outputs.EXE_NAME }}"
          }
          if (-not (Test-Path $exePath)) {
            Write-Host "âŒ æ— æ³•æ‰§è¡Œï¼Œæœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: $exePath"
            exit 1
          }
          $env:NUITKA_PROBE_FLAG = "workflow_run"
          Write-Host "æ‰§è¡Œ: $exePath"
          & $exePath
